<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">DH1项目HelpMe索引表</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
    
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }
        
        /* Header样式 */
        header {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            padding: 8px 30px;
            position: relative;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            position: relative;
            padding-right: 50px;
        }
        
        h1 {
            font-size: 2.2rem;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        /* Header状态栏 */
        .header-status {
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 8px;
            min-height: 36px;
            min-width: 200px;
            flex-shrink: 0;
        }
        
        .header-status i {
            font-size: 0.9rem;
        }
        
        .status-warning {
            background: rgba(255, 193, 7, 0.15);
            color: #ffc107;
        }
        
        .status-success {
            background: rgba(40, 167, 69, 0.15);
            color: #28a745;
        }
        
        .status-error {
            background: rgba(220, 53, 69, 0.15);
            color: #dc3545;
        }
        
        .status-info {
            background: rgba(23, 162, 184, 0.15);
            color: #17a2b8;
        }
        
        /* 管理员按钮样式 */
        .admin-toggle-btn {
            position: absolute;
            top: 25px;
            right: 30px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.3s;
            z-index: 100;
        }
        
        .admin-toggle-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        
        .admin-toggle-btn.active {
            background: rgba(255, 255, 255, 0.3);
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.5);
        }
        
        /* 认证面板 */
        .auth-panel {
            position: absolute;
            top: 75px;
            right: 30px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            width: 400px;
            z-index: 1000;
            display: none;
            overflow: hidden;
        }
        
        .auth-panel.show {
            display: block;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .auth-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #eaeaea;
        }
        
        .auth-tab {
            flex: 1;
            padding: 15px;
            background: none;
            border: none;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s;
            color: #666;
            border-bottom: 3px solid transparent;
        }
        
        .auth-tab.active {
            color: #6a11cb;
            border-bottom-color: #6a11cb;
            background: white;
            font-weight: 600;
        }
        
        .auth-tab-content {
            padding: 25px;
        }
        
        /* 用户信息区域 */
        .auth-user-info {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #eaeaea;
            display: none;
        }
        
        .auth-user-info.show {
            display: block;
        }
        
        .user-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .user-details-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #6a11cb;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .logout-btn-small {
            padding: 6px 12px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        
        .logout-btn-small:hover {
            background: #c82333;
        }
        
        .auth-form-group {
            margin-bottom: 20px;
        }
        
        .auth-form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
            font-size: 0.9rem;
        }
        
        .auth-input {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9rem;
            transition: all 0.3s;
        }
        
        .auth-input:focus {
            outline: none;
            border-color: #6a11cb;
            box-shadow: 0 0 0 2px rgba(106, 17, 203, 0.2);
        }
        
        .auth-btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 10px;
        }
        
        .auth-btn-primary {
            background: #6a11cb;
            color: white;
        }
        
        .auth-btn-primary:hover {
            background: #5a0db5;
        }
        
        .auth-btn-success {
            background: #28a745;
            color: white;
        }
        
        .auth-btn-success:hover {
            background: #218838;
        }
        
        .auth-btn-info {
            background: #17a2b8;
            color: white;
        }
        
        .auth-btn-info:hover {
            background: #138496;
        }
        
        .auth-btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .auth-btn-secondary:hover {
            background: #5a6268;
        }
        
        .auth-btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .auth-btn-danger:hover {
            background: #c82333;
        }
        
        .auth-buttons-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .auth-buttons-group .auth-btn {
            flex: 1;
            margin-top: 0;
        }
        
        .auth-status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 6px;
            font-size: 0.85rem;
            display: none;
        }
        
        .auth-status.show {
            display: block;
        }
        
        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .github-info {
            background: #e8f5e9;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            border-left: 4px solid #28a745;
        }
        
        .github-info p {
            margin: 5px 0;
            font-size: 0.85rem;
            color: #388e3c;
        }
        
        .github-info i {
            margin-right: 8px;
        }
        
        /* 隐藏原来的认证部分 */
        .auth-section {
            display: none !important;
        }
        
        .permission-hint {
            display: none !important;
        }
        
        /* 控制区域 - 重新设计布局 */
        .controls {
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #eaeaea;
        }
        
        .controls-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .controls-row:last-child {
            margin-bottom: 0;
        }
        
        .search-box {
            flex: 0 0 250px;
            min-width: 250px;
            position: relative;
        }
        
        .search-box input {
            width: 100%;
            padding: 12px 20px 12px 40px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .search-box input:focus {
            outline: none;
            border-color: #6a11cb;
            box-shadow: 0 0 0 2px rgba(106, 17, 203, 0.2);
        }
        
        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #888;
        }
        
        /* 分类筛选器区域 - 自动换行 */
        .filter-box {
            display: flex;
            gap: 8px;
            flex: 1;
            min-width: 300px;
            flex-wrap: wrap; /* 允许换行 */
        }
        
        .filter-btn {
            padding: 10px 18px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        .filter-btn:hover {
            background: #f0f0f0;
        }
        
        .filter-btn.active {
            background: #6a11cb;
            color: white;
            border-color: #6a11cb;
        }
        
        /* 操作按钮区域 - 重新设计 */
        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap; /* 允许换行 */
            width: 100%;
        }
        
        /* 主操作按钮组 */
        .main-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            flex: 1;
        }
        
        /* 排序控制按钮组 */
        .sort-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-left: 10px;
        }
        
        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            flex-shrink: 0;
            height: 42px;
            box-sizing: border-box;
        }
        
        .btn-primary {
            background: #6a11cb;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a0db5;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        
        .btn-warning:hover {
            background: #e0a800;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .table-container {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background: #f8f9fa;
        }
        
        th {
            padding: 16px 20px;
            text-align: left;
            font-weight: 600;
            color: #555;
            border-bottom: 2px solid #eaeaea;
            font-size: 0.95rem;
            position: relative;
        }
        
        .editable-header {
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .editable-header:hover {
            background: #e9ecef;
        }
        
        .editable-header .edit-icon {
            opacity: 0;
            margin-left: 5px;
            font-size: 0.8rem;
            transition: opacity 0.2s;
        }
        
        .editable-header:hover .edit-icon {
            opacity: 1;
        }
        
        td {
            padding: 16px 20px;
            border-bottom: 1px solid #eaeaea;
            font-size: 0.95rem;
        }
        
        tbody tr {
            transition: background 0.2s;
        }
        
        tbody tr:hover {
            background: #f8f9ff;
        }
        
        /* 统一的分类配色系统 */
        :root {
            --category-color-1: #1976d2;  /* 蓝色 */
            --category-color-2: #388e3c;  /* 绿色 */
            --category-color-3: #d35400;  /* 深橙色 */
            --category-color-4: #c2185b;  /* 粉红色 */
            --category-color-5: #7b1fa2;  /* 紫色 */
            --category-color-6: #009688;  /* 蓝绿色 */
            --category-color-7: #ff5722;  /* 红色橙色 */
            --category-color-8: #795548;  /* 棕色 */
            --category-color-9: #303f9f;  /* 深蓝色 */
            --category-color-10: #00bcd4; /* 青色 */
            --category-color-11: #9c27b0; /* 紫罗兰色 */
            --category-color-12: #ff9800; /* 琥珀色 */
            --category-color-13: #607d8b; /* 蓝灰色 */
            --category-color-14: #8bc34a; /* 浅绿色 */
            --category-color-15: #ff4081; /* 玫红色 */
            --category-color-16: #ff6f00; /* 橙黄色 */
            --category-color-17: #4caf50; /* 青绿色 */
            --category-color-18: #673ab7; /* 深紫色 */
            --category-color-19: #00acc1; /* 青蓝色 */
            --category-color-20: #ff1744; /* 亮红色 */
        }
        
        .category {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        /* 分类标签使用统一的配色 */
        .category-1 { background: #e3f2fd; color: var(--category-color-1); }
        .category-2 { background: #e8f5e9; color: var(--category-color-2); }
        .category-3 { background: #ffe0b2; color: var(--category-color-3); }
        .category-4 { background: #fce4ec; color: var(--category-color-4); }
        .category-5 { background: #f3e5f5; color: var(--category-color-5); }
        .category-6 { background: #e0f2f1; color: var(--category-color-6); }
        .category-7 { background: #ffecb3; color: var(--category-color-7); }
        .category-8 { background: #efebe9; color: var(--category-color-8); }
        .category-9 { background: #e8eaf6; color: var(--category-color-9); }
        .category-10 { background: #e0f7fa; color: var(--category-color-10); }
        .category-11 { background: #f3e5f5; color: var(--category-color-11); }
        .category-12 { background: #fff3e0; color: var(--category-color-12); }
        .category-13 { background: #eceff1; color: var(--category-color-13); }
        .category-14 { background: #f1f8e9; color: var(--category-color-14); }
        .category-15 { background: #fce4ec; color: var(--category-color-15); }
        .category-16 { background: #fff3e0; color: var(--category-color-16); }
        .category-17 { background: #e8f5e9; color: var(--category-color-17); }
        .category-18 { background: #f3e5f5; color: var(--category-color-18); }
        .category-19 { background: #e0f7fa; color: var(--category-color-19); }
        .category-20 { background: #ffebee; color: var(--category-color-20); }
        
        /* 链接使用相同的分类颜色 */
        .link {
            color: inherit; /* 继承分类颜色 */
            text-decoration: none;
            transition: opacity 0.2s;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .link:hover {
            opacity: 0.8;
            text-decoration: underline;
        }
        
        /* 文件夹链接使用特定的绿色 */
        .folder-link {
            color: var(--category-color-2); /* 使用分类2的绿色 */
        }
        
        .folder-link:hover {
            opacity: 0.8;
            text-decoration: underline;
        }
        
        .link-icon {
            font-size: 0.9rem;
        }
        
        .note {
            color: #666;
            font-size: 0.9rem;
            white-space: pre-wrap;
            word-break: break-word;
            line-height: 1.4;
        }

        .empty-row {
            text-align: center;
            padding: 40px;
            color: #888;
        }
        
        .action-cell {
            display: flex;
            gap: 8px;
        }
        
        .action-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            padding: 5px;
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .action-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        .edit-btn {
            color: #17a2b8;
        }
        
        .edit-btn:hover:not(:disabled) {
            background: #e6f7fa;
        }
        
        .delete-btn {
            color: #dc3545;
        }
        
        .delete-btn:hover:not(:disabled) {
            background: #fbe7e9;
        }
        
        .path-type-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            margin-left: 8px;
            font-weight: 500;
            opacity: 0.9;
        }
        
        .badge-url {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .badge-folder {
            background: #e8f5e9;
            color: #388e3c;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }
        
        .modal-header {
            padding: 20px 25px;
            background: #f8f9fa;
            border-bottom: 1px solid #eaeaea;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 1.3rem;
            font-weight: 600;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6c757d;
        }
        
        .modal-body {
            padding: 25px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #6a11cb;
            box-shadow: 0 0 0 2px rgba(106, 17, 203, 0.2);
        }
        
        #itemNote {
            white-space: pre-wrap;
            word-break: break-word;
            line-height: 1.4;
            min-height: 80px;
            resize: vertical;
            font-family: inherit;
        }
        
        .form-select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            background: white;
            cursor: pointer;
        }
        
        .path-type-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .path-type-btn {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }
        
        .path-type-btn.active {
            background: #6a11cb;
            color: white;
            border-color: #6a11cb;
        }
        
        .path-example {
            font-size: 0.8rem;
            color: #666;
            margin-top: 5px;
        }
        
        .modal-footer {
            padding: 15px 25px;
            background: #f8f9fa;
            border-top: 1px solid #eaeaea;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .stats {
            padding: 15px 30px;
            background: #f8f9fa;
            border-top: 1px solid #eaeaea;
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: #666;
        }
        
        .loading-indicator {
            padding: 10px 15px;
            background: #d1ecf1;
            border-radius: 6px;
            margin: 10px 0;
            font-size: 0.9rem;
            color: #0c5460;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .error-message {
            display: none;
        }
        
        .path-display {
            font-size: 0.8rem;
            color: #666;
            margin-top: 4px;
            word-break: break-all;
        }
        
        .header-edit-input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 2px solid #6a11cb;
            background: white;
            padding: 0 15px;
            font-size: 0.95rem;
            font-weight: 600;
            outline: none;
        }
        
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 6px;
            color: white;
            z-index: 10000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 400px;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s ease;
        }
        
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .toast-success {
            background: #28a745;
        }
        
        .toast-error {
            background: #dc3545;
        }
        
        .toast-info {
            background: #17a2b8;
        }
        
        .toast-warning {
            background: #ffc107;
            color: #212529;
        }
        
        /* 拖拽排序样式 */
        .draggable-row {
            cursor: move;
            transition: all 0.2s ease;
        }
        
        .draggable-row.dragging {
            background: #f0f7ff !important;
            box-shadow: 0 4px 12px rgba(106, 17, 203, 0.2);
            opacity: 0.8;
            border: 2px dashed #6a11cb;
        }
        
        .draggable-row.drag-over {
            border-top: 3px solid #2575fc;
        }
        
        .drag-handle {
            cursor: grab;
            color: #6c757d;
            padding: 0 8px;
            margin-right: 8px;
            transition: color 0.2s;
        }
        
        .drag-handle:hover {
            color: #6a11cb;
        }
        
        .drag-handle:active {
            cursor: grabbing;
        }
        
        /* 排序按钮样式 */
        .sort-btn {
            padding: 10px 18px;
            background: #6c757d;
            border: 1px solid #6c757d;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            flex-shrink: 0;
            height: 42px;
            box-sizing: border-box;
        }
        
        .sort-btn:hover {
            background: #5a6268;
            border-color: #545b62;
        }
        
        .sort-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* 响应式设计 */
        @media (max-width: 1024px) {
            .controls-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-box {
                width: 100%;
                flex: 0 0 auto;
            }
            
            .filter-box {
                width: 100%;
                justify-content: flex-start;
            }
            
            .action-buttons {
                flex-direction: column;
                gap: 10px;
            }
            
            .main-actions, .sort-actions {
                width: 100%;
                margin-left: 0;
                justify-content: flex-start;
            }
        }
        
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
                padding-right: 50px;
            }
            
            .header-status {
                width: 100%;
            }
            
            .auth-panel {
                width: calc(100% - 60px);
                right: 15px;
                left: 15px;
                margin: 0 auto;
            }
            
            .controls {
                padding: 15px;
            }
            
            th, td {
                padding: 12px 15px;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            .btn, .sort-btn {
                padding: 8px 12px;
                font-size: 0.85rem;
                height: 38px;
            }
            
            .filter-btn {
                padding: 8px 12px;
                font-size: 0.85rem;
            }
            
            .stats {
                flex-direction: column;
                gap: 10px;
            }
        }
        
        @media (max-width: 480px) {
            .btn, .sort-btn {
                padding: 6px 10px;
                font-size: 0.8rem;
                gap: 5px;
                height: 36px;
            }
            
            .filter-btn {
                padding: 6px 10px;
                font-size: 0.8rem;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            .controls {
                padding: 12px;
            }
            
            .controls-row {
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div>
                    <h1 id="mainTitle">DH1项目HelpMe索引表</h1>
                    <div class="header-status" id="headerStatus">
                        <i class="fas fa-info-circle"></i>
                        <span id="statusText">正在初始化系统...</span>
                    </div>
                </div>
            </div>
            
            <!-- 管理员按钮 -->
            <button class="admin-toggle-btn" id="adminToggleBtn" title="管理员登录/配置">
                <i class="fas fa-user-cog"></i>
            </button>
            
            <!-- 认证面板 -->
            <div class="auth-panel" id="authPanel">
                <!-- 用户信息区域（登录后显示） -->
                <div class="auth-user-info" id="authUserInfo">
                    <div class="user-details">
                        <div class="user-details-left">
                            <div class="user-avatar" id="userAvatar">A</div>
                            <div>
                                <div style="font-weight: 600;" id="userDisplayName">管理员</div>
                                <div style="font-size: 0.8rem; color: #666;" id="userRole">管理员</div>
                            </div>
                        </div>
                        <button class="logout-btn-small" id="panelLogoutBtn">
                            <i class="fas fa-sign-out-alt"></i> 退出
                        </button>
                    </div>
                </div>
                
                <div class="auth-tabs">
                    <button class="auth-tab active" data-tab="login">管理员登录</button>
                    <button class="auth-tab" data-tab="github">GitHub配置</button>
                </div>
                
                <div class="auth-tab-content" id="loginTab">
                    <div class="auth-form-group">
                        <label for="authUsername">用户名</label>
                        <input type="text" id="authUsername" class="auth-input" placeholder="输入用户名">
                    </div>
                    <div class="auth-form-group">
                        <label for="authPassword">密码</label>
                        <input type="password" id="authPassword" class="auth-input" placeholder="输入密码">
                    </div>
                    <button class="auth-btn auth-btn-primary" id="authLoginBtn">登录</button>
                    <button class="auth-btn auth-btn-info" id="testAccountBtn">使用测试账号</button>
                    <div class="auth-buttons-group">
                        <button class="auth-btn auth-btn-secondary" id="cancelLoginBtn">取消</button>
                    </div>
                    <div class="auth-status" id="loginStatus"></div>
                </div>
                
                <div class="auth-tab-content" id="githubTab" style="display: none;">
                    <div class="auth-form-group">
                        <label for="authGithubToken">GitHub个人访问令牌</label>
                        <input type="password" id="authGithubToken" class="auth-input" placeholder="输入GitHub令牌">
                        <div class="github-info">
                            <p><i class="fas fa-check-circle"></i> 完全免费 - 不会产生任何费用</p>
                            <p><i class="fas fa-shield-alt"></i> 令牌仅保存在您的浏览器本地</p>
                            <p><i class="fas fa-question-circle"></i> 
                                <a href="javascript:void(0)" onclick="showGitHubTokenHelp()" style="color: #388e3c; text-decoration: underline;">
                                    如何获取令牌？
                                </a>
                            </p>
                        </div>
                    </div>
                    <button class="auth-btn auth-btn-success" id="authSetupGithubBtn">配置GitHub同步</button>
                    <div class="auth-buttons-group">
                        <button class="auth-btn auth-btn-secondary" id="cancelGithubBtn">取消</button>
                    </div>
                    <div class="auth-status" id="githubStatus"></div>
                </div>
            </div>
        </header>
        
        <!-- 配置加载状态指示器 -->
        <div class="loading-indicator" id="loadingIndicator" style="display: none;">
            <i class="fas fa-sync fa-spin"></i>
            <span id="loadingText">正在从GitHub securityconfig加载配置...</span>
        </div>
        
        <div class="controls">
            <!-- 第一行：搜索和分类筛选 -->
            <div class="controls-row">
                <div class="search-box">
                    <span class="search-icon"><i class="fas fa-search"></i></span>
                    <input type="text" id="searchInput" placeholder="搜索名称、分类或备注...">
                </div>
                
                <div class="filter-box" id="filterBox">
                    <button class="filter-btn active" data-category="all">全部</button>
                    <!-- 分类按钮将通过JavaScript动态生成 -->
                </div>
            </div>
            
            <!-- 第二行：操作按钮 -->
            <div class="controls-row">
                <div class="action-buttons">
                    <!-- 主操作按钮 -->
                    <div class="main-actions">
                        <button class="btn btn-primary" id="addBtn" style="display: none;">
                            <i class="fas fa-plus"></i> 添加新条目
                        </button>
                        
                        <button class="btn btn-success" id="exportBtn" style="display: none;">
                            <i class="fas fa-file-export"></i> 导出数据
                        </button>
                        <button class="btn btn-success" id="syncExcelBtn" style="display: none;">
                            <i class="fas fa-sync"></i> 同步到 Excel
                        </button>
                        <button class="btn btn-success" id="downloadExcelBtn">
                            <i class="fas fa-download"></i> 下载 Excel
                        </button>
                        <button class="btn btn-warning" id="repairExcelBtn" style="display: none;">
                            <i class="fas fa-tools"></i> 修复Excel格式
                        </button>
                        <button class="btn btn-success" id="updateHTMLBtn" style="display: none;">
                            <i class="fas fa-download"></i> 更新HTML
                        </button>
                        <button class="btn btn-danger" id="resetBtn" style="display: none;">
                            <i class="fas fa-redo"></i> 重置数据
                        </button>
                        <button class="btn btn-primary" id="refreshConfigBtn">
                            <i class="fas fa-sync-alt"></i> 刷新配置
                        </button>
                        <button class="btn btn-primary" id="editHeadersBtn" style="display: none;">
                            <i class="fas fa-edit"></i> 编辑表头
                        </button>
                    </div>
                    
                    <!-- 排序控制按钮 -->
                    <div class="sort-actions" id="sortControls" style="display: none;">
                        <button class="sort-btn" id="enableSortBtn" title="启用拖拽排序">
                            <i class="fas fa-arrows-alt"></i> 调整顺序
                        </button>
                        <button class="sort-btn" id="saveOrderBtn" title="保存顺序" style="display: none;">
                            <i class="fas fa-save"></i> 保存顺序
                        </button>
                        <button class="sort-btn" id="cancelSortBtn" title="取消排序" style="display: none;">
                            <i class="fas fa-times"></i> 取消
                        </button>
                        <button class="sort-btn" id="resetOrderBtn" title="重置为默认顺序">
                            <i class="fas fa-undo"></i> 重置顺序
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th width="8%" class="editable-header" data-field="id">
                            <span id="header-id">序号</span>
                            <i class="fas fa-edit edit-icon"></i>
                        </th>
                        <th width="10%" class="editable-header" data-field="category">
                            <span id="header-category">分类</span>
                            <i class="fas fa-edit edit-icon"></i>
                        </th>
                        <th width="50%" class="editable-header" data-field="path">
                            <span id="header-path">链接地址</span>
                            <i class="fas fa-edit edit-icon"></i>
                        </th>
                        <th width="25%" class="editable-header" data-field="note">
                            <span id="header-note">备注</span>
                            <i class="fas fa-edit edit-icon"></i>
                        </th>
                        <th width="7%">操作</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <!-- 表格内容将通过JavaScript动态生成 -->
                </tbody>
            </table>
        </div>
        
        <div class="stats">
            <div id="totalCount">总计: 0 个项目</div>
            <div id="filteredCount">显示: 0 个项目</div>
            <div id="configVersion">配置版本: 加载中...</div>
        </div>
    </div>

    <!-- 添加/编辑模态框 -->
    <div class="modal" id="itemModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">添加新条目</h3>
                <button class="close-btn" id="closeModal">×</button>
            </div>
            <div class="modal-body">
                <form id="itemForm">
                    <input type="hidden" id="editId" value="">
                    <div class="form-group">
                        <label class="form-label" for="itemTitle">页面标题</label>
                        <input type="text" class="form-control" id="itemTitle" placeholder="输入页面标题" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="itemCategory">分类</label>
                        <select class="form-select" id="itemCategory" required>
                            <option value="">选择分类</option>
                            <!-- 分类选项将通过JavaScript动态生成 -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">路径类型</label>
                        <div class="path-type-selector">
                            <button type="button" class="path-type-btn active" data-type="url">网页URL</button>
                            <button type="button" class="path-type-btn" data-type="folder">文件夹路径</button>
                        </div>
                        <input type="text" class="form-control" id="itemPath" placeholder="输入网页URL地址" required>
                        <div class="path-example" id="pathExample">例如: https://example.com/page</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="itemNote">备注</label>
                        <textarea class="form-control" id="itemNote" placeholder="输入备注信息" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn cancel-btn" id="cancelBtn">取消</button>
                <button class="btn btn-primary" id="saveItemBtn">保存</button>
            </div>
        </div>
    </div>

    <!-- 表头编辑模态框 -->
    <div class="modal" id="headersModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">编辑表头名称</h3>
                <button class="close-btn" id="closeHeadersModal">×</button>
            </div>
            <div class="modal-body">
                <form id="headersForm">
                    <div class="form-group">
                        <label class="form-label" for="headerIdInput">序号列名称</label>
                        <input type="text" class="form-control" id="headerIdInput" placeholder="输入序号列名称">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="headerCategoryInput">分类列名称</label>
                        <input type="text" class="form-control" id="headerCategoryInput" placeholder="输入分类列名称">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="headerPathInput">链接地址列名称</label>
                        <input type="text" class="form-control" id="headerPathInput" placeholder="输入链接地址列名称">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="headerNoteInput">备注列名称</label>
                        <input type="text" class="form-control" id="headerNoteInput" placeholder="输入备注列名称">
                    </div>
                </form>
                <div class="permission-hint">
                    <i class="fas fa-info-circle"></i>
                    <span>修改表头名称后，页面显示会立即更新，同时会保存到本地存储中。</span>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn cancel-btn" id="cancelHeadersBtn">取消</button>
                <button class="btn btn-primary" id="saveHeadersBtn">保存表头</button>
                <button class="btn btn-success" id="resetHeadersBtn">重置表头</button>
            </div>
        </div>
    </div>

    <!-- 引入SheetJS库用于处理Excel文件 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script>
        // ========== 项目配置 ==========
        // 只需修改这里的变量，就可以切换到其他项目
        
        const PROJECT_CONFIG = {
            // 项目标识（DH3, DH1, 等）
            prefix: 'DH1',
            
            // 项目完整名称
            name: 'DH1项目',
            
            // GitHub仓库配置
            githubOwner: 'Cybereign',
            githubRepo: 'DH1SecurityConfig',
            githubBranch: 'main',
            
            // 本地存储键名前缀
            storagePrefix: 'DH1h5Index',
            
            // 默认数据 - 使用外部文件加载
            defaultData: [],
            
            // 默认管理员账户
            defaultAdminAccounts: [
                { 
                    username: "admin", 
                    passwordHash: "240be518fabd2724ddb6f04eeb1da5967448d7e831c08c8fa822809f74c720a9", // admin123
                    name: "系统管理员",
                    permissions: ["read", "write", "delete", "export", "config"]
                },
                { 
                    username: "user", 
                    passwordHash: "ecb666d778725ec97307044d642bf4d160aabb76f56c0069c71ea25b1e926825", // user123
                    name: "普通用户",
                    permissions: ["read", "write"]
                }
            ],
            
            // 默认应用配置
            defaultAppConfig: {
                version: "1.0.0",
                autoLogout: 60,
                maxLoginAttempts: 5,
                source: "Builtin"
            },
            
            // 默认分类列表 - 将动态从数据中提取
            defaultCategoryList: [],
            
            // 默认分类映射 - 将动态从数据中构建
            defaultCategoryMap: {}
        };

        // 从配置中提取变量
        const PROJECT_PREFIX = PROJECT_CONFIG.prefix;
        const PROJECT_NAME = PROJECT_CONFIG.name;
        const GITHUB_OWNER = PROJECT_CONFIG.githubOwner;
        const GITHUB_REPO = PROJECT_CONFIG.githubRepo;
        const GITHUB_BRANCH = PROJECT_CONFIG.githubBranch;
        const STORAGE_PREFIX = PROJECT_CONFIG.storagePrefix;
        
        let DEFAULT_TABLE_DATA = []; // 将从外部文件加载
        const DEFAULT_ADMIN_ACCOUNTS = PROJECT_CONFIG.defaultAdminAccounts;
        const DEFAULT_APP_CONFIG = PROJECT_CONFIG.defaultAppConfig;

        // 基于配置的GitHub URLs
        const GITHUB_CONFIG_BASE = `https://raw.githubusercontent.com/${GITHUB_OWNER}/${GITHUB_REPO}/${GITHUB_BRANCH}`;
        const GITHUB_API_BASE = 'https://api.github.com';
        const GITHUB_CONTENT_URL = `${GITHUB_API_BASE}/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents`;

        // ========== 全局变量 ==========
        
        // 示例数据 - 将从GitHub配置加载
        let tableData = [];
        
        // 用户账户信息和配置
        let adminAccounts = [];
        let appConfig = {};
        let categoryMap = {};
        let categoryList = [];

        // 表头配置
        let headerConfig = {
            id: '序号',
            category: '分类',
            path: '链接地址',
            note: '备注'
        };

        // 拖拽排序相关变量
        let isSortMode = false;
        let dragSrcEl = null;
        let originalOrder = [];

        // GitHub服务实例
        let gitHubService = null;

        // 自动登出和登录尝试
        let logoutTimer;
        let loginAttempts = 0;

        // 当前显示的数据和路径类型
        let currentData = [];
        let currentPathType = 'url';
        let isLoggedIn = false;
        let currentUser = null;

        // 页面状态
        let currentStatus = {
            type: 'info',
            message: '正在初始化系统...',
            showLoginHint: true
        };

        // DOM元素
        const tableBody = document.getElementById('tableBody');
        const searchInput = document.getElementById('searchInput');
        const addBtn = document.getElementById('addBtn');
        const exportBtn = document.getElementById('exportBtn');
        const syncExcelBtn = document.getElementById('syncExcelBtn');
        const downloadExcelBtn = document.getElementById('downloadExcelBtn');
        const repairExcelBtn = document.getElementById('repairExcelBtn');
        const updateHTMLBtn = document.getElementById('updateHTMLBtn');
        const resetBtn = document.getElementById('resetBtn');
        const refreshConfigBtn = document.getElementById('refreshConfigBtn');
        const editHeadersBtn = document.getElementById('editHeadersBtn');
        const itemModal = document.getElementById('itemModal');
        const headersModal = document.getElementById('headersModal');
        const modalTitle = document.getElementById('modalTitle');
        const itemForm = document.getElementById('itemForm');
        const headersForm = document.getElementById('headersForm');
        const editId = document.getElementById('editId');
        const itemTitle = document.getElementById('itemTitle');
        const itemCategory = document.getElementById('itemCategory');
        const itemPath = document.getElementById('itemPath');
        const itemNote = document.getElementById('itemNote');
        const saveItemBtn = document.getElementById('saveItemBtn');
        const closeModal = document.getElementById('closeModal');
        const closeHeadersModal = document.getElementById('closeHeadersModal');
        const cancelBtn = document.getElementById('cancelBtn');
        const cancelHeadersBtn = document.getElementById('cancelHeadersBtn');
        const saveHeadersBtn = document.getElementById('saveHeadersBtn');
        const resetHeadersBtn = document.getElementById('resetHeadersBtn');
        const totalCount = document.getElementById('totalCount');
        const filteredCount = document.getElementById('filteredCount');
        const configVersion = document.getElementById('configVersion');
        const pathTypeButtons = document.querySelectorAll('.path-type-btn');
        const pathExample = document.getElementById('pathExample');
        const pageTitle = document.getElementById('pageTitle');
        const mainTitle = document.getElementById('mainTitle');
        const filterBox = document.getElementById('filterBox');
        const sortControls = document.getElementById('sortControls');
        const enableSortBtn = document.getElementById('enableSortBtn');
        const saveOrderBtn = document.getElementById('saveOrderBtn');
        const cancelSortBtn = document.getElementById('cancelSortBtn');
        const resetOrderBtn = document.getElementById('resetOrderBtn');
        
        // 新增的认证相关DOM元素
        const adminToggleBtn = document.getElementById('adminToggleBtn');
        const authPanel = document.getElementById('authPanel');
        const authUserInfo = document.getElementById('authUserInfo');
        const userAvatar = document.getElementById('userAvatar');
        const userDisplayName = document.getElementById('userDisplayName');
        const userRole = document.getElementById('userRole');
        const panelLogoutBtn = document.getElementById('panelLogoutBtn');
        const authTabs = document.querySelectorAll('.auth-tab');
        const loginTab = document.getElementById('loginTab');
        const githubTab = document.getElementById('githubTab');
        const authUsername = document.getElementById('authUsername');
        const authPassword = document.getElementById('authPassword');
        const authLoginBtn = document.getElementById('authLoginBtn');
        const testAccountBtn = document.getElementById('testAccountBtn');
        const cancelLoginBtn = document.getElementById('cancelLoginBtn');
        const authGithubToken = document.getElementById('authGithubToken');
        const authSetupGithubBtn = document.getElementById('authSetupGithubBtn');
        const cancelGithubBtn = document.getElementById('cancelGithubBtn');
        const loginStatus = document.getElementById('loginStatus');
        const githubStatus = document.getElementById('githubStatus');
        const headerStatus = document.getElementById('headerStatus');
        const statusText = document.getElementById('statusText');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const loadingText = document.getElementById('loadingText');

        // ========== 初始化页面标题和标题 ==========
        function initPageTitles() {
            const pageTitleText = `${PROJECT_NAME}HelpMe索引表`;
            const mainTitleText = `${PROJECT_NAME}HelpMe索引表`;
            
            pageTitle.textContent = pageTitleText;
            mainTitle.textContent = mainTitleText;
        }

        // ========== 加载外部数据文件 ==========
        async function loadDefaultDataFromJS() {
            try {
                console.log('🔄 尝试加载 default-data.js 文件...');
                
                // 从与index.html同目录的default-data.js文件加载
                const response = await fetch('default-data.js');
                
                if (!response.ok) {
                    console.error('default-data.js 文件加载失败:', response.status);
                    throw new Error(`default-data.js 文件加载失败: ${response.status}`);
                }
                
                const jsContent = await response.text();
                console.log('✅ default-data.js 文件加载成功，内容长度:', jsContent.length);
                
                // 尝试解析JavaScript文件
                let loadedData = null;
                
                // 方法1: 尝试执行JavaScript代码
                try {
                    // 创建一个临时函数来执行代码
                    const tempFunction = new Function(jsContent);
                    tempFunction();
                    
                    // 检查全局变量是否被定义
                    if (typeof window.DEFAULT_TABLE_DATA !== 'undefined') {
                        loadedData = window.DEFAULT_TABLE_DATA;
                        console.log('✅ 从全局变量 DEFAULT_TABLE_DATA 加载数据成功，数据条数:', loadedData.length);
                    }
                } catch (e) {
                    console.log('执行JavaScript方法失败:', e.message);
                }
                
                // 方法2: 尝试直接解析数据（如果是JSON格式）
                if (!loadedData) {
                    try {
                        // 尝试提取JSON数据
                        const jsonMatch = jsContent.match(/DEFAULT_TABLE_DATA\s*=\s*(\[.*?\])/s);
                        if (jsonMatch && jsonMatch[1]) {
                            loadedData = JSON.parse(jsonMatch[1]);
                            console.log('✅ 从JSON解析数据成功，数据条数:', loadedData.length);
                        }
                    } catch (e) {
                        console.log('JSON解析方法失败:', e.message);
                    }
                }
                
                // 方法3: 如果上面都失败，显示空表格而不是示例数据
                if (!loadedData || !Array.isArray(loadedData) || loadedData.length === 0) {
                    console.warn('⚠️ 无法从 default-data.js 加载有效数据，使用空数据');
                    loadedData = []; // 改为空数组
                    
                    // 显示空表格
                    tableBody.innerHTML = `<tr><td colspan="5" class="empty-row">正在加载数据，请稍候...</td></tr>`;
                    updateStatus('warning', '外部数据文件为空或格式不正确');
                }
                
                DEFAULT_TABLE_DATA = loadedData;
                
                // 动态构建分类
                buildCategoriesFromData();
                
                return true;
                
            } catch (error) {
                console.error('❌ 加载外部数据文件失败:', error);
                
                // 显示空表格而不是示例数据
                DEFAULT_TABLE_DATA = [];
                tableBody.innerHTML = `<tr><td colspan="5" class="empty-row">数据加载失败，请刷新页面重试</td></tr>`;
                updateStatus('error', '外部数据文件加载失败');
                
                return false;
            }
        }

        // ========== 从数据构建分类系统 ==========
        function buildCategoriesFromData() {
            console.log('🔧 从数据构建分类系统...');
            
            // 从数据中提取所有唯一的分类
            const categoriesSet = new Set();
            DEFAULT_TABLE_DATA.forEach(item => {
                if (item.category && item.category.trim()) {
                    categoriesSet.add(item.category.trim());
                }
            });
            
            // 将Set转换为数组并排序
            const categoriesArray = Array.from(categoriesSet).sort((a, b) => 
                a.localeCompare(b, 'zh-CN')
            );
            
            console.log('📊 从数据中提取的分类:', categoriesArray);
            
            // 构建分类列表和映射
            categoryList = [];
            categoryMap = {};
            
            categoriesArray.forEach((categoryName, index) => {
                const categoryId = `category${index + 1}`;
                categoryList.push({
                    id: categoryId,
                    name: categoryName
                });
                categoryMap[categoryId] = categoryName;
            });
            
            console.log('✅ 构建的分类系统:', {
                categoryList: categoryList,
                categoryMap: categoryMap
            });
        }

        // ========== GitHub API 服务类 ==========

        class GitHubService {
            constructor(token) {
                this.token = token;
            }

            async getFileContent(filePath) {
                try {
                    const response = await fetch(`${GITHUB_CONTENT_URL}/${filePath}?ref=${GITHUB_BRANCH}`, {
                        headers: {
                            'Authorization': `token ${this.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });

                    if (!response.ok) {
                        if (response.status === 404) {
                            return null;
                        }
                        throw new Error(`获取文件失败: ${response.status}`);
                    }

                    const data = await response.json();
                    const content = atob(data.content);
                    return {
                        content: content,
                        sha: data.sha,
                        exists: true
                    };
                } catch (error) {
                    console.error('获取文件内容失败:', error);
                    throw error;
                }
            }

            async updateFileContent(filePath, content, sha, commitMessage) {
                try {
                    const payload = {
                        message: commitMessage,
                        content: content,
                        branch: GITHUB_BRANCH
                    };

                    if (sha) {
                        payload.sha = sha;
                    }

                    const response = await fetch(`${GITHUB_CONTENT_URL}/${filePath}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${this.token}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        
                        if (response.status === 409) {
                            throw new Error(`文件版本冲突。请先点击"修复Excel格式"按钮，然后重试。`);
                        }
                        
                        throw new Error(`更新文件失败: ${response.status} - ${errorData.message}`);
                    }

                    const data = await response.json();
                    console.log('文件更新成功:', data);
                    return data;
                } catch (error) {
                    console.error('更新文件失败:', error);
                    throw error;
                }
            }

            async checkAuth() {
                try {
                    const response = await fetch(`${GITHUB_API_BASE}/user`, {
                        headers: {
                            'Authorization': `token ${this.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });

                    if (!response.ok) {
                        throw new Error('GitHub 认证失败');
                    }

                    const userData = await response.json();
                    return {
                        authenticated: true,
                        username: userData.login
                    };
                } catch (error) {
                    return {
                        authenticated: false,
                        error: error.message
                    };
                }
            }

            async forceCreateFile(filePath, content, commitMessage) {
                try {
                    let currentFile = null;
                    try {
                        currentFile = await this.getFileContent(filePath);
                    } catch (error) {
                        console.log('文件不存在或获取失败，将创建新文件');
                    }

                    const payload = {
                        message: commitMessage,
                        content: content,
                        branch: GITHUB_BRANCH
                    };

                    if (currentFile && currentFile.exists) {
                        payload.sha = currentFile.sha;
                    }

                    const response = await fetch(`${GITHUB_CONTENT_URL}/${filePath}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${this.token}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        
                        if (response.status === 409) {
                            console.log('文件冲突，尝试强制创建新文件...');
                            return await this.forceCreateNewFile(filePath, content, commitMessage);
                        }
                        
                        throw new Error(`强制创建文件失败: ${response.status} - ${errorData.message}`);
                    }

                    const data = await response.json();
                    console.log('文件强制创建成功:', data);
                    return data;
                } catch (error) {
                    console.error('强制创建文件失败:', error);
                    throw error;
                }
            }

            async forceCreateNewFile(filePath, content, commitMessage) {
                try {
                    const payload = {
                        message: commitMessage,
                        content: content,
                        branch: GITHUB_BRANCH
                    };

                    const response = await fetch(`${GITHUB_CONTENT_URL}/${filePath}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${this.token}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`创建新文件失败: ${response.status} - ${errorData.message}`);
                    }

                    const data = await response.json();
                    console.log('新文件创建成功:', data);
                    return data;
                } catch (error) {
                    console.error('创建新文件失败:', error);
                    throw error;
                }
            }
        }

        // ========== 核心功能函数 ==========

        // 使用外部数据文件
        async function useExternalDataConfig(showMessage = true) {
            try {
                // 确保已加载外部数据
                if (DEFAULT_TABLE_DATA.length === 0) {
                    const success = await loadDefaultDataFromJS();
                    if (!success) {
                        throw new Error('外部数据文件加载失败');
                    }
                }
                
                // 如果外部数据为空，显示空表格
                if (DEFAULT_TABLE_DATA.length === 0) {
                    tableData = [];
                    tableBody.innerHTML = `<tr><td colspan="5" class="empty-row">暂无数据，请添加条目或从外部数据源加载</td></tr>`;
                    updateStats();
                    
                    if (showMessage) {
                        updateStatus('warning', '外部数据文件为空');
                    }
                    return false;
                }
                
                tableData = JSON.parse(JSON.stringify(DEFAULT_TABLE_DATA));
                adminAccounts = JSON.parse(JSON.stringify(DEFAULT_ADMIN_ACCOUNTS));
                appConfig = JSON.parse(JSON.stringify(DEFAULT_APP_CONFIG));
                
                // 重新构建分类（从数据中动态构建）
                buildCategoriesFromData();
                
                tableData.forEach((item, index) => {
                    item.id = index + 1;
                });
                appConfig.source = 'ExternalData';
                updateConfigVersionInfo(appConfig);
                updateCategoryFilters();
                updateCategorySelect();
                renderTable(tableData);
                updateStats();
                
                if (isSortMode) {
                    exitSortMode();
                }
                
                if (showMessage) {
                    updateStatus('success', '已加载外部数据配置');
                }
                return true;
            } catch (error) {
                console.error('使用外部数据配置失败:', error);
                tableData = [];
                tableBody.innerHTML = `<tr><td colspan="5" class="empty-row">数据加载失败: ${error.message}</td></tr>`;
                updateStats();
                updateStatus('error', `配置加载失败: ${error.message}`);
                return false;
            }
        }

        // ========== 优化的初始化流程 ==========

        document.addEventListener('DOMContentLoaded', async () => {
            console.log(`🔄 ${PROJECT_NAME}系统初始化开始...`);
            
            // 1. 初始化页面标题
            initPageTitles();
            
            // 2. 显示初始化状态
            tableBody.innerHTML = `<tr><td colspan="5" class="empty-row">正在初始化系统，请稍候...</td></tr>`;
            updateStats();
            
            // 3. 加载本地配置
            const savedHeaders = loadHeadersFromStorage();
            if (savedHeaders) {
                headerConfig = savedHeaders;
            }
            updateTableHeaders();
            
            // 4. 加载GitHub令牌（如果有）
            loadGitHubToken();

            // 5. 设置基础UI
            configVersion.textContent = '配置版本: 加载中...';
            updateStatus('info', '正在初始化系统...');
            
            // 6. 设置事件监听器
            setupEventListeners();
            setupAuthEvents();
            checkLoginStatus();
            updateCategorySelect();
            updateButtonVisibility();
            
            // 7. 初始化拖拽排序
            initSorting();
            
            // 8. 设置自动登出监听器
            document.addEventListener('click', resetAutoLogoutTimer);
            document.addEventListener('keypress', resetAutoLogoutTimer);
            document.addEventListener('mousemove', resetAutoLogoutTimer);
            
            // 9. 异步加载外部数据文件
            console.log('🔄 开始加载外部数据文件...');
            
            try {
                const success = await loadDefaultDataFromJS();
                
                if (success && DEFAULT_TABLE_DATA.length > 0) {
                    // 成功加载到数据，立即显示
                    await useExternalDataConfig(false); // 不显示消息
                    console.log('✅ 外部数据文件加载成功，数据条数:', DEFAULT_TABLE_DATA.length);
                    updateStatus('success', '已加载外部数据配置');
                } else {
                    // 数据为空或加载失败
                    console.log('⚠️ 外部数据文件为空或加载失败');
                    tableData = [];
                    tableBody.innerHTML = `<tr><td colspan="5" class="empty-row">暂无数据，请添加条目或等待GitHub数据加载</td></tr>`;
                    updateStats();
                    updateStatus('warning', '外部数据文件为空或加载失败');
                }
                
            } catch (error) {
                console.error('❌ 外部数据文件加载异常:', error);
                tableData = [];
                tableBody.innerHTML = `<tr><td colspan="5" class="empty-row">数据加载失败，请刷新页面重试</td></tr>`;
                updateStats();
                updateStatus('error', '数据加载失败');
            }
            
            // 10. 异步尝试从GitHub加载最新数据
            console.log(`🔄 开始异步尝试从GitHub加载${PROJECT_NAME}最新数据...`);
            
            setTimeout(async () => {
                try {
                    console.log('🔄 异步尝试连接GitHub...');
                    
                    const githubDataLoaded = await loadConfigFromGitHub();
                    
                    if (githubDataLoaded && tableData.length > 0) {
                        console.log('✅ GitHub数据加载成功，更新显示');
                        appConfig.source = `GitHub ${PROJECT_NAME}SecurityConfig`;
                        
                        // 更新配置信息
                        updateConfigVersionInfo(appConfig);
                        
                        if (isLoggedIn) {
                            updateStatus('success', `已成功加载${PROJECT_NAME}GitHub最新配置，您当前是管理员模式`);
                        } else {
                            updateStatus('success', `已成功加载${PROJECT_NAME}GitHub最新配置，您当前是访客模式，只能查看数据。请登录管理员账户以进行添加、编辑和删除操作。`);
                        }
                        
                        showToast(`✅ 已成功从GitHub加载${PROJECT_NAME}最新数据`, 'success');
                    } else if (githubDataLoaded && tableData.length === 0) {
                        // GitHub数据也为空
                        console.log('⚠️ GitHub数据加载成功但为空');
                        appConfig.source = `GitHub ${PROJECT_NAME}SecurityConfig (空数据)`;
                        updateConfigVersionInfo(appConfig);
                        updateStatus('info', 'GitHub数据加载成功但为空，请添加数据');
                    } else {
                        // GitHub加载失败，继续使用当前数据
                        console.log('⚠️ GitHub加载失败，继续使用当前数据');
                        if (tableData.length > 0) {
                            appConfig.source = `ExternalData (${PROJECT_NAME}GitHub连接失败)`;
                        } else {
                            appConfig.source = `无数据 (${PROJECT_NAME}GitHub连接失败)`;
                        }
                        updateConfigVersionInfo(appConfig);
                        
                        const savedData = loadDataFromStorage();
                        if (savedData && savedData.length > 0) {
                            console.log('📊 使用本地存储的数据');
                            tableData = savedData;
                            currentData = [...tableData];
                            
                            // 重新构建分类
                            rebuildCategoriesFromTableData();
                            
                            renderTable(currentData);
                            updateStats();
                            
                            updateStatus('warning', `${PROJECT_NAME}GitHub连接失败，使用本地缓存数据。您当前是访客模式，只能查看数据。请登录管理员账户以进行添加、编辑和删除操作。`);
                        } else if (tableData.length === 0) {
                            updateStatus('warning', `${PROJECT_NAME}GitHub连接失败，且无本地数据。您当前是访客模式，只能查看数据。请登录管理员账户以添加新条目。`);
                        }
                    }
                    
                } catch (error) {
                    console.error('❌ 异步加载GitHub数据异常:', error);
                    // 错误已经被处理，继续使用当前数据
                }
                
                console.log(`📊 ${PROJECT_NAME}初始化完成，最终数据量: ${tableData.length} 条记录，来源: ${appConfig.source}`);
                if (tableData.length > 0) {
                    showToast(`${PROJECT_NAME}系统初始化完成，数据来源: ${appConfig.source}`, 'success');
                } else {
                    showToast(`${PROJECT_NAME}系统初始化完成，暂无数据`, 'info');
                }
                
            }, 100); // 稍微延迟，确保外部数据先显示
            
            console.log(`✅ ${PROJECT_NAME}系统基础初始化完成`);
        });

        // ========== 认证面板功能 ==========

        // 设置认证面板事件
        function setupAuthEvents() {
            // 管理员按钮点击事件
            adminToggleBtn.addEventListener('click', toggleAuthPanel);
            
            // 认证标签页切换
            authTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    authTabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    if (tab.dataset.tab === 'login') {
                        loginTab.style.display = 'block';
                        githubTab.style.display = 'none';
                    } else {
                        loginTab.style.display = 'none';
                        githubTab.style.display = 'block';
                    }
                });
            });
            
            // 登录按钮
            authLoginBtn.addEventListener('click', handleAuthLogin);
            
            // 测试账号按钮
            testAccountBtn.addEventListener('click', () => {
                authUsername.value = 'admin';
                authPassword.value = 'admin123';
                showAuthStatus('loginStatus', '已填充测试账号，点击登录按钮即可', 'info');
            });
            
            // 取消登录按钮
            cancelLoginBtn.addEventListener('click', hideAuthPanel);
            
            // GitHub配置按钮
            authSetupGithubBtn.addEventListener('click', handleAuthGithubSetup);
            
            // 取消GitHub配置按钮
            cancelGithubBtn.addEventListener('click', hideAuthPanel);
            
            // 面板内退出按钮
            panelLogoutBtn.addEventListener('click', handleLogout);
            
            // 回车登录
            authPassword.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleAuthLogin();
                }
            });
            
            authGithubToken.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleAuthGithubSetup();
                }
            });
            
            // 点击页面其他地方关闭认证面板
            document.addEventListener('click', (e) => {
                if (!authPanel.contains(e.target) && !adminToggleBtn.contains(e.target)) {
                    hideAuthPanel();
                }
            });
        }

        // 切换认证面板显示/隐藏
        function toggleAuthPanel() {
            if (authPanel.classList.contains('show')) {
                hideAuthPanel();
            } else {
                showAuthPanel();
            }
        }

        // 显示认证面板
        function showAuthPanel() {
            authPanel.classList.add('show');
            adminToggleBtn.classList.add('active');
            
            // 更新用户信息显示
            updateAuthUserInfo();
            
            // 切换到登录标签页
            authTabs.forEach(tab => tab.classList.remove('active'));
            document.querySelector('[data-tab="login"]').classList.add('active');
            loginTab.style.display = 'block';
            githubTab.style.display = 'none';
            
            // 清空状态消息
            clearAuthStatus();
            
            // 自动聚焦用户名输入框
            setTimeout(() => {
                if (isLoggedIn) {
                    // 如果已登录，聚焦GitHub令牌输入框
                    authGithubToken.focus();
                } else {
                    authUsername.focus();
                }
            }, 100);
        }

        // 隐藏认证面板
        function hideAuthPanel() {
            authPanel.classList.remove('show');
            adminToggleBtn.classList.remove('active');
            clearAuthStatus();
            
            // 清空输入框
            authUsername.value = '';
            authPassword.value = '';
            authGithubToken.value = '';
        }

        // 更新认证面板中的用户信息
        function updateAuthUserInfo() {
            if (isLoggedIn && currentUser) {
                authUserInfo.classList.add('show');
                userDisplayName.textContent = currentUser.name;
                userRole.textContent = '管理员';
                userAvatar.textContent = currentUser.name.charAt(0).toUpperCase();
            } else {
                authUserInfo.classList.remove('show');
            }
        }

        // 清空认证状态消息
        function clearAuthStatus() {
            loginStatus.innerHTML = '';
            loginStatus.className = 'auth-status';
            githubStatus.innerHTML = '';
            githubStatus.className = 'auth-status';
        }

        // 显示认证状态消息
        function showAuthStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = message;
                element.className = `auth-status show status-${type}`;
                
                if (type === 'success') {
                    setTimeout(() => {
                        element.innerHTML = '';
                        element.className = 'auth-status';
                    }, 3000);
                }
            }
        }

        // 更新页面状态显示
        function updateStatus(type, message) {
            currentStatus.type = type;
            currentStatus.message = message;
            
            headerStatus.className = `header-status status-${type}`;
            statusText.textContent = message;
            
            if (isLoggedIn) {
                currentStatus.showLoginHint = false;
            } else {
                currentStatus.showLoginHint = true;
            }
        }

        // 处理认证登录
        async function handleAuthLogin() {
            const username = authUsername.value.trim();
            const password = authPassword.value.trim();
            
            if (!username || !password) {
                showAuthStatus('loginStatus', '请输入用户名和密码', 'error');
                return;
            }
            
            const maxAttempts = appConfig.maxLoginAttempts || 5;
            if (loginAttempts >= maxAttempts) {
                showAuthStatus('loginStatus', `登录尝试次数过多，请稍后再试。最大尝试次数：${maxAttempts}`, 'error');
                return;
            }
            
            const passwordHash = await sha256(password);
            const user = adminAccounts.find(acc => 
                acc.username === username && acc.passwordHash === passwordHash
            );
            
            if (user) {
                loginAttempts = 0;
                loginSuccess(user);
                hideAuthPanel();
                authPassword.value = '';
                showAuthStatus('loginStatus', '登录成功！', 'success');
            } else {
                loginAttempts++;
                const remainingAttempts = maxAttempts - loginAttempts;
                showAuthStatus('loginStatus', `用户名或密码错误，剩余尝试次数：${remainingAttempts}`, 'error');
                authPassword.value = '';
                authPassword.focus();
            }
        }

        // 处理认证GitHub配置
        async function handleAuthGithubSetup() {
            const token = authGithubToken.value.trim();
            
            if (!token) {
                showAuthStatus('githubStatus', '请输入GitHub令牌', 'error');
                return;
            }
            
            try {
                showAuthStatus('githubStatus', '正在验证令牌...', 'info');
                gitHubService = new GitHubService(token);
                const authResult = await gitHubService.checkAuth();
                
                if (authResult.authenticated) {
                    localStorage.setItem(`${STORAGE_PREFIX}GithubToken`, token);
                    authGithubToken.value = '';
                    showAuthStatus('githubStatus', `验证成功！用户: ${authResult.username}`, 'success');
                    
                    updateButtonVisibility();
                    
                    if (isLoggedIn) {
                        updateStatus('success', `已加载${PROJECT_NAME}配置，您当前是管理员模式，GitHub已连接`);
                    }
                } else {
                    throw new Error('令牌验证失败');
                }
            } catch (error) {
                console.error('GitHub配置失败:', error);
                showAuthStatus('githubStatus', `配置失败: ${error.message}`, 'error');
            }
        }

        // GitHub令牌帮助
        function showGitHubTokenHelp() {
            alert(`GitHub 个人访问令牌 - 完全免费\n\n` +
                  `如何获取：\n` +
                  `1. 登录 GitHub → Settings → Developer settings\n` +
                  `2. 选择 Personal access tokens → Tokens (classic)\n` +
                  `3. 点击 Generate new token\n` +
                  `4. 设置备注，选择过期时间（建议1年）\n` +
                  `5. 勾选 repo 权限（完整控制私有仓库）\n` +
                  `6. 生成令牌并复制保存\n\n` +
                  `💡 重要提示：\n` +
                  `• 这个功能完全免费\n` +
                  `• 不会产生任何费用\n` +
                  `• 令牌只保存在您的浏览器本地\n` +
                  `• 可以随时在 GitHub 上撤销令牌`);
            
            authTabs.forEach(tab => tab.classList.remove('active'));
            document.querySelector('[data-tab="github"]').classList.add('active');
            loginTab.style.display = 'none';
            githubTab.style.display = 'block';
            authGithubToken.focus();
        }

        // ========== 核心功能函数（续） ==========

        // SHA-256哈希函数
        async function sha256(message) {
            const msgString = String(message);
            const encoder = new TextEncoder();
            const data = encoder.encode(msgString);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }

        // 创建分类颜色映射函数
        function createCategoryColorMap() {
            const colorMap = {};
            const uniqueCategories = [...new Set(tableData.map(item => item.category).filter(Boolean))];
            
            // 按分类名称排序，确保颜色分配的一致性
            const sortedCategories = uniqueCategories.sort((a, b) => a.localeCompare(b, 'zh-CN'));
            
            sortedCategories.forEach((category, index) => {
                const colorIndex = (index % 20) + 1;
                colorMap[category] = `category-${colorIndex}`;
            });
            
            return colorMap;
        }

        // 渲染表格
        function renderTable(data) {
            console.log(`🔄 渲染表格，数据条数: ${data.length}`);
            
            if (data.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="5" class="empty-row">暂无数据</td></tr>`;
                updateStats();
                return;
            }
            
            const categoryColorMap = createCategoryColorMap();
            
            tableBody.innerHTML = data.map(item => {
                const isUrl = item.type === 'url';
                const iconClass = isUrl ? 'fas fa-external-link-alt' : 'fas fa-folder-open';
                const badgeClass = isUrl ? 'badge-url' : 'badge-folder';
                const badgeText = isUrl ? '网页' : '文件夹';
                const categoryName = item.category || `分类${item.id}`;
                const categoryClass = categoryColorMap[categoryName] || 'category-1';
                
                // 从categoryClass提取颜色编号，用于链接继承相同的颜色
                const colorNumber = categoryClass.replace('category-', '');
                
                if (isUrl) {
                    return `
                    <tr>
                        <td>${item.id}</td>
                        <td><span class="category ${categoryClass}">${categoryName}</span></td>
                        <td>
                            <a href="${item.path}" target="_blank" class="link" style="color: var(--category-color-${colorNumber});">
                                <i class="${iconClass} link-icon"></i> 
                                ${item.title}
                                <span class="path-type-badge ${badgeClass}">${badgeText}</span>
                            </a>
                            <div class="path-display">${item.path}</div>
                        </td>
                        <td class="note">${item.note}</td>
                        <td class="action-cell">
                            <button class="action-btn edit-btn" data-id="${item.id}" ${isLoggedIn ? '' : 'disabled'}>
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn delete-btn" data-id="${item.id}" ${isLoggedIn ? '' : 'disabled'}>
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                    `;
                } else {
                    return `
                    <tr>
                        <td>${item.id}</td>
                        <td><span class="category ${categoryClass}">${categoryName}</span></td>
                        <td>
                            <a href="#" class="link folder-link" onclick="return openFolder('${item.path.replace(/\\/g, '\\\\')}')" style="color: var(--category-color-${colorNumber});">
                                <i class="${iconClass} link-icon"></i> 
                                ${item.title}
                                <span class="path-type-badge ${badgeClass}">${badgeText}</span>
                            </a>
                            <div class="path-display">${item.path}</div>
                        </td>
                        <td class="note">${item.note}</td>
                        <td class="action-cell">
                            <button class="action-btn edit-btn" data-id="${item.id}" ${isLoggedIn ? '' : 'disabled'}>
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn delete-btn" data-id="${item.id}" ${isLoggedIn ? '' : 'disabled'}>
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                    `;
                }
            }).join('');
            
            if (isSortMode) {
                makeRowsDraggable();
            }
            
            document.querySelectorAll('.edit-btn').forEach(btn => {
                if (!btn.disabled) {
                    btn.addEventListener('click', (e) => {
                        const id = parseInt(e.currentTarget.dataset.id);
                        openModal(id);
                    });
                }
            });
            
            document.querySelectorAll('.delete-btn').forEach(btn => {
                if (!btn.disabled) {
                    btn.addEventListener('click', (e) => {
                        const id = parseInt(e.currentTarget.dataset.id);
                        deleteItem(id);
                    });
                }
            });
            
            updateStats();
        }

        // ========== 拖拽排序功能 ==========

        // 初始化排序功能
        function initSorting() {
            if (isLoggedIn && currentUser && currentUser.permissions.includes('write')) {
                sortControls.style.display = 'flex';
            }

            enableSortBtn.addEventListener('click', enableSortMode);
            saveOrderBtn.addEventListener('click', saveNewOrder);
            cancelSortBtn.addEventListener('click', cancelSortMode);
            resetOrderBtn.addEventListener('click', resetToDefaultOrder);
        }

        // 启用排序模式
        function enableSortMode() {
            if (!isLoggedIn) {
                alert('请先登录管理员账户');
                return;
            }

            isSortMode = true;
            originalOrder = [...tableData];
            
            enableSortBtn.style.display = 'none';
            saveOrderBtn.style.display = 'inline-block';
            cancelSortBtn.style.display = 'inline-block';
            
            makeRowsDraggable();
            
            showToast('拖拽排序模式已启用，拖动行可以调整顺序', 'info');
        }

        // 使行可拖拽
        function makeRowsDraggable() {
            const rows = tableBody.querySelectorAll('tr');
            
            rows.forEach(row => {
                row.classList.add('draggable-row');
                
                const idCell = row.cells[0];
                if (!idCell.querySelector('.drag-handle')) {
                    const dragHandle = document.createElement('span');
                    dragHandle.className = 'drag-handle';
                    dragHandle.innerHTML = '<i class="fas fa-arrows-alt"></i>';
                    idCell.insertBefore(dragHandle, idCell.firstChild);
                }
                
                row.setAttribute('draggable', 'true');
                
                row.removeEventListener('dragstart', handleDragStart);
                row.removeEventListener('dragover', handleDragOver);
                row.removeEventListener('dragenter', handleDragEnter);
                row.removeEventListener('dragleave', handleDragLeave);
                row.removeEventListener('drop', handleDrop);
                row.removeEventListener('dragend', handleDragEnd);
                
                row.addEventListener('dragstart', handleDragStart);
                row.addEventListener('dragover', handleDragOver);
                row.addEventListener('dragenter', handleDragEnter);
                row.addEventListener('dragleave', handleDragLeave);
                row.addEventListener('drop', handleDrop);
                row.addEventListener('dragend', handleDragEnd);
            });
        }

        // 拖拽事件处理函数
        function handleDragStart(e) {
            if (!isSortMode) {
                e.preventDefault();
                return;
            }
            
            this.classList.add('dragging');
            dragSrcEl = this;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
        }

        function handleDragOver(e) {
            if (!isSortMode) return;
            
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDragEnter(e) {
            if (!isSortMode) return;
            
            this.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            if (!isSortMode) return;
            
            this.classList.remove('drag-over');
        }

        function handleDrop(e) {
            if (!isSortMode) return;
            
            e.stopPropagation();
            e.preventDefault();
            
            if (dragSrcEl !== this) {
                const allRows = Array.from(tableBody.querySelectorAll('tr'));
                const srcIndex = allRows.indexOf(dragSrcEl);
                const destIndex = allRows.indexOf(this);
                
                if (srcIndex < destIndex) {
                    tableBody.insertBefore(dragSrcEl, this.nextSibling);
                } else {
                    tableBody.insertBefore(dragSrcEl, this);
                }
                
                updateRowNumbers();
            }
            
            this.classList.remove('drag-over');
            return false;
        }

        function handleDragEnd(e) {
            if (!isSortMode) return;
            
            const rows = tableBody.querySelectorAll('tr');
            rows.forEach(row => {
                row.classList.remove('dragging');
                row.classList.remove('drag-over');
            });
        }

        // 更新行号显示
        function updateRowNumbers() {
            const rows = tableBody.querySelectorAll('tr');
            rows.forEach((row, index) => {
                const idCell = row.cells[0];
                const dragHandle = idCell.querySelector('.drag-handle');
                idCell.innerHTML = '';
                if (dragHandle) {
                    idCell.appendChild(dragHandle);
                }
                idCell.appendChild(document.createTextNode(index + 1));
            });
        }

        // 保存新顺序
        function saveNewOrder() {
            if (!isSortMode) return;
            
            const rows = tableBody.querySelectorAll('tr');
            const newOrder = [];
            
            rows.forEach(row => {
                const id = parseInt(row.querySelector('.edit-btn').dataset.id);
                const item = tableData.find(item => item.id === id);
                if (item) {
                    newOrder.push(item);
                }
            });
            
            tableData = newOrder;
            
            tableData.forEach((item, index) => {
                item.id = index + 1;
            });
            
            saveDataToStorage();
            exitSortMode();
            
            showToast('顺序已保存！', 'success');
        }

        // 取消排序模式
        function cancelSortMode() {
            if (!isSortMode) return;
            
            tableData = originalOrder;
            
            const searchTerm = searchInput.value.toLowerCase();
            const activeCategory = document.querySelector('.filter-btn.active')?.dataset.category || 'all';
            filterTable(searchTerm, activeCategory);
            
            exitSortMode();
            showToast('顺序调整已取消', 'info');
        }

        // 退出排序模式
        function exitSortMode() {
            isSortMode = false;
            dragSrcEl = null;
            originalOrder = [];
            
            enableSortBtn.style.display = 'inline-block';
            saveOrderBtn.style.display = 'none';
            cancelSortBtn.style.display = 'none';
            
            const rows = tableBody.querySelectorAll('tr');
            rows.forEach(row => {
                row.classList.remove('draggable-row');
                row.setAttribute('draggable', 'false');
                
                const dragHandle = row.querySelector('.drag-handle');
                if (dragHandle) {
                    dragHandle.remove();
                }
            });
        }

        // 重置为默认顺序
        function resetToDefaultOrder() {
            if (!isLoggedIn) {
                alert('请先登录管理员账户');
                return;
            }
            
            if (!confirm('确定要重置为默认顺序吗？这将丢失所有自定义排序。')) {
                return;
            }
            
            useExternalDataConfig();
            
            showToast('已重置为默认顺序', 'success');
        }

        // ========== 数据管理函数 ==========

        // 数据持久化函数
        function saveDataToStorage() {
            localStorage.setItem(`${STORAGE_PREFIX}Data`, JSON.stringify(tableData));
        }

        function loadDataFromStorage() {
            const savedData = localStorage.getItem(`${STORAGE_PREFIX}Data`);
            if (savedData) {
                return JSON.parse(savedData);
            }
            return null;
        }

        // 表头配置持久化
        function saveHeadersToStorage() {
            localStorage.setItem(`${STORAGE_PREFIX}Headers`, JSON.stringify(headerConfig));
        }

        function loadHeadersFromStorage() {
            const savedHeaders = localStorage.getItem(`${STORAGE_PREFIX}Headers`);
            if (savedHeaders) {
                return JSON.parse(savedHeaders);
            }
            return null;
        }

        // 设置自动登出
        function setupAutoLogout() {
            if (logoutTimer) {
                clearTimeout(logoutTimer);
            }
            
            const autoLogoutMinutes = appConfig.autoLogout || 60;
            
            logoutTimer = setTimeout(() => {
                if (isLoggedIn) {
                    alert(`由于长时间未操作，系统已自动登出。自动登出时间：${autoLogoutMinutes}分钟`);
                    handleLogout();
                }
            }, autoLogoutMinutes * 60 * 1000);
        }

        // 重置自动登出计时器
        function resetAutoLogoutTimer() {
            if (isLoggedIn) {
                setupAutoLogout();
            }
        }

        // 更新表格表头显示
        function updateTableHeaders() {
            document.getElementById('header-id').textContent = headerConfig.id;
            document.getElementById('header-category').textContent = headerConfig.category;
            document.getElementById('header-path').textContent = headerConfig.path;
            document.getElementById('header-note').textContent = headerConfig.note;

            searchInput.placeholder = `搜索名称、${headerConfig.category.toLowerCase()}或${headerConfig.note.toLowerCase()}...`;
        }

        // 检查登录状态
        function checkLoginStatus() {
            const savedUser = localStorage.getItem(`${STORAGE_PREFIX}CurrentUser`);
            if (savedUser) {
                const user = JSON.parse(savedUser);
                loginSuccess(user);
            }
        }

        // 设置事件监听器
        function setupEventListeners() {
            searchInput.addEventListener('input', handleSearch);
            
            pathTypeButtons.forEach(btn => {
                btn.addEventListener('click', handlePathTypeChange);
            });
            
            addBtn.addEventListener('click', () => openModal());
            
            exportBtn.addEventListener('click', exportData);
            
            syncExcelBtn.addEventListener('click', syncDataToExcel);
            
            downloadExcelBtn.addEventListener('click', downloadExcel);
            
            repairExcelBtn.addEventListener('click', repairExcelFormat);
            
            updateHTMLBtn.addEventListener('click', downloadUpdatedHTML);
            
            resetBtn.addEventListener('click', resetData);
            
            refreshConfigBtn.addEventListener('click', refreshConfig);
            
            editHeadersBtn.addEventListener('click', openHeadersModal);
            
            closeModal.addEventListener('click', closeModalFunc);
            closeHeadersModal.addEventListener('click', closeHeadersModalFunc);
            cancelBtn.addEventListener('click', closeModalFunc);
            cancelHeadersBtn.addEventListener('click', closeHeadersModalFunc);
            saveItemBtn.addEventListener('click', saveItem);
            saveHeadersBtn.addEventListener('click', saveHeaders);
            resetHeadersBtn.addEventListener('click', resetHeaders);
            
            setupHeaderEditListeners();
            
            setupFilterEvents();
        }

        // 设置表头编辑事件
        function setupHeaderEditListeners() {
            const editableHeaders = document.querySelectorAll('.editable-header');
            editableHeaders.forEach(header => {
                header.addEventListener('click', (e) => {
                    if (isLoggedIn && currentUser && currentUser.permissions.includes('config')) {
                        editHeader(e.currentTarget);
                    }
                });
            });
        }

        // 编辑单个表头
        function editHeader(headerElement) {
            const field = headerElement.dataset.field;
            const currentText = headerElement.querySelector('span').textContent;
            
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'header-edit-input';
            input.value = currentText;
            
            headerElement.style.position = 'relative';
            headerElement.appendChild(input);
            input.focus();
            input.select();
            
            const saveEdit = () => {
                const newValue = input.value.trim();
                if (newValue && newValue !== currentText) {
                    headerConfig[field] = newValue;
                    saveHeadersToStorage();
                    updateTableHeaders();
                }
                headerElement.removeChild(input);
            };
            
            input.addEventListener('blur', saveEdit);
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    saveEdit();
                }
                if (e.key === 'Escape') {
                    headerElement.removeChild(input);
                }
            });
        }

        // 设置筛选事件
        function setupFilterEvents() {
            const filterButtons = document.querySelectorAll('.filter-btn');
            filterButtons.forEach(btn => {
                btn.addEventListener('click', handleFilter);
            });
        }

        // 处理路径类型变化
        function handlePathTypeChange(e) {
            pathTypeButtons.forEach(btn => btn.classList.remove('active'));
            e.currentTarget.classList.add('active');
            currentPathType = e.currentTarget.dataset.type;
            
            if (currentPathType === 'url') {
                pathExample.textContent = '例如: https://example.com/page';
                itemPath.placeholder = '输入网页URL地址';
            } else {
                pathExample.textContent = '例如: \\\\10.4.9.25\\Project\\文件夹 或 D:\\Projects\\文件夹';
                itemPath.placeholder = '输入文件夹路径';
            }
        }

        // 处理搜索
        function handleSearch() {
            const searchTerm = searchInput.value.toLowerCase();
            const activeCategory = document.querySelector('.filter-btn.active')?.dataset.category || 'all';
            filterTable(searchTerm, activeCategory);
        }

        // 处理筛选
        function handleFilter(e) {
            const filterButtons = document.querySelectorAll('.filter-btn');
            filterButtons.forEach(btn => btn.classList.remove('active'));
            e.currentTarget.classList.add('active');
            
            const searchTerm = searchInput.value.toLowerCase();
            const category = e.currentTarget.dataset.category;
            filterTable(searchTerm, category);
        }

        // 筛选表格数据
        function filterTable(searchTerm, category) {
            let filteredData = tableData;
            
            if (searchTerm) {
                filteredData = filteredData.filter(item => 
                    item.title.toLowerCase().includes(searchTerm) || 
                    (item.category || '').toLowerCase().includes(searchTerm) ||
                    item.note.toLowerCase().includes(searchTerm) ||
                    item.path.toLowerCase().includes(searchTerm)
                );
            }
            
            if (category !== 'all') {
                const selectedCategory = categoryList.find(cat => cat.id === category);
                if (selectedCategory) {
                    filteredData = filteredData.filter(item => item.category === selectedCategory.name);
                }
            }
            
            currentData = filteredData;
            renderTable(currentData);
        }

        // 打开模态框
        function openModal(id = null) {
            if (!isLoggedIn) {
                alert('请先登录管理员账户');
                return;
            }
            
            console.log('🔍 打开模态框，项目ID:', id);
            
            if (id) {
                const item = tableData.find(item => item.id === id);
                if (item) {
                    console.log('🔍 编辑项目信息:');
                    console.log('- 项目ID:', item.id);
                    console.log('- 项目分类名称:', item.category);
                    
                    modalTitle.textContent = '编辑条目';
                    editId.value = item.id;
                    itemTitle.value = item.title;
                    
                    // 查找对应的分类ID
                    let categoryId = '';
                    if (item.category) {
                        const categoryEntry = Object.entries(categoryMap).find(([id, name]) => name === item.category);
                        
                        if (categoryEntry) {
                            categoryId = categoryEntry[0];
                            console.log(`✅ 找到分类映射: "${item.category}" -> ${categoryId}`);
                        } else {
                            console.warn(`❌ 未找到分类 "${item.category}" 的映射`);
                        }
                    }
                    
                    console.log('设置分类选择器值为:', categoryId);
                    itemCategory.value = categoryId;
                    
                    itemPath.value = item.path;
                    itemNote.value = item.note;
                    
                    currentPathType = item.type;
                    pathTypeButtons.forEach(btn => {
                        btn.classList.toggle('active', btn.dataset.type === item.type);
                    });
                    updatePathExample();
                }
            } else {
                modalTitle.textContent = '添加新条目';
                itemForm.reset();
                editId.value = '';
                
                currentPathType = 'url';
                pathTypeButtons.forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.type === 'url');
                });
                updatePathExample();
            }
            
            itemModal.style.display = 'flex';
        }

        // 更新路径示例
        function updatePathExample() {
            if (currentPathType === 'url') {
                pathExample.textContent = '例如: https://example.com/page';
                itemPath.placeholder = '输入网页URL地址';
            } else {
                pathExample.textContent = '例如: \\\\10.4.9.25\\Project\\文件夹 或 D:\\Projects\\文件夹';
                itemPath.placeholder = '输入文件夹路径';
            }
        }

        // 关闭模态框
        function closeModalFunc() {
            itemModal.style.display = 'none';
            itemForm.reset();
        }

        // 保存条目
        function saveItem() {
            if (!isLoggedIn) {
                alert('请先登录管理员账户');
                return;
            }
            
            if (!itemTitle.value.trim() || !itemCategory.value || !itemPath.value.trim()) {
                alert('请填写所有必填字段！');
                return;
            }
            
            const pathValue = itemPath.value.trim();
            let detectedType = currentPathType;
            
            if (pathValue.startsWith('http://') || pathValue.startsWith('https://')) {
                detectedType = 'url';
            } else if (pathValue.includes('\\\\') || pathValue.includes(':\\')) {
                detectedType = 'folder';
            }
            
            const id = editId.value ? parseInt(editId.value) : generateId();
            
            let categoryName;
            let categoryId = itemCategory.value;
            
            // 查找分类名称
            if (categoryId && categoryMap[categoryId]) {
                categoryName = categoryMap[categoryId];
            } else {
                // 如果是新分类
                categoryName = categoryId;
                categoryId = `category${categoryList.length + 1}`;
                
                const newCategory = {
                    id: categoryId,
                    name: categoryName
                };
                categoryList.push(newCategory);
                categoryMap[categoryId] = categoryName;
                
                updateCategoryFilters();
                updateCategorySelect();
                
                console.log('✅ 新分类已添加:', newCategory);
            }
            
            const newItem = {
                id: id,
                category: categoryName,
                title: itemTitle.value.trim(),
                path: pathValue,
                type: detectedType,
                note: itemNote.value.trim()
            };
            
            if (editId.value) {
                const index = tableData.findIndex(item => item.id === id);
                if (index !== -1) {
                    tableData[index] = newItem;
                }
            } else {
                tableData.push(newItem);
            }
            
            saveDataToStorage();
            
            const searchTerm = searchInput.value.toLowerCase();
            const activeCategory = document.querySelector('.filter-btn.active')?.dataset.category || 'all';
            filterTable(searchTerm, activeCategory);
            
            closeModalFunc();
            showToast('条目保存成功！', 'success');
        }

        // 生成新ID
        function generateId() {
            return tableData.length > 0 ? Math.max(...tableData.map(item => item.id)) + 1 : 1;
        }

        // 删除条目
        function deleteItem(id) {
            if (!isLoggedIn) {
                alert('请先登录管理员账户');
                return;
            }
            
            if (confirm('确定要删除这个条目吗？')) {
                tableData = tableData.filter(item => item.id !== id);
                saveDataToStorage();
                
                const searchTerm = searchInput.value.toLowerCase();
                const activeCategory = document.querySelector('.filter-btn.active')?.dataset.category || 'all';
                filterTable(searchTerm, activeCategory);
                
                showToast('条目删除成功！', 'success');
            }
        }

        // 导出数据
        function exportData() {
            const dataStr = JSON.stringify(tableData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `${PROJECT_PREFIX.toLowerCase()}-index-data.json`;
            link.click();
            
            showToast('数据导出成功！', 'success');
        }

        // 打开表头编辑模态框
        function openHeadersModal() {
            if (!isLoggedIn) {
                alert('请先登录管理员账户');
                return;
            }
            
            document.getElementById('headerIdInput').value = headerConfig.id;
            document.getElementById('headerCategoryInput').value = headerConfig.category;
            document.getElementById('headerPathInput').value = headerConfig.path;
            document.getElementById('headerNoteInput').value = headerConfig.note;
            
            headersModal.style.display = 'flex';
        }

        // 关闭表头编辑模态框
        function closeHeadersModalFunc() {
            headersModal.style.display = 'none';
        }

        // 保存表头配置
        function saveHeaders() {
            const newHeaders = {
                id: document.getElementById('headerIdInput').value.trim() || '序号',
                category: document.getElementById('headerCategoryInput').value.trim() || '分类',
                path: document.getElementById('headerPathInput').value.trim() || '链接地址',
                note: document.getElementById('headerNoteInput').value.trim() || '备注'
            };
            
            headerConfig = newHeaders;
            saveHeadersToStorage();
            updateTableHeaders();
            closeHeadersModalFunc();
            showToast('表头名称已更新！', 'success');
        }

        // 重置表头配置
        function resetHeaders() {
            headerConfig = {
                id: '序号',
                category: '分类',
                path: '链接地址',
                note: '备注'
            };
            saveHeadersToStorage();
            updateTableHeaders();
            closeHeadersModalFunc();
            showToast('表头名称已重置为默认值！', 'success');
        }

        // 刷新配置
        async function refreshConfig() {
            console.log(`🔄 手动刷新${PROJECT_NAME}配置...`);
            
            try {
                const success = await loadConfigFromGitHub(true); // 强制刷新
                
                if (success) {
                    showToast(`${PROJECT_NAME}配置刷新成功！已从GitHub加载最新数据`, 'success');
                    
                    if (isLoggedIn && currentUser) {
                        const updatedUser = adminAccounts.find(acc => acc.username === currentUser.username);
                        if (updatedUser) {
                            currentUser.permissions = updatedUser.permissions;
                            updateUIForPermissions();
                            updateButtonVisibility();
                        }
                    }
                } else {
                    // GitHub刷新失败，使用当前数据
                    showToast(`${PROJECT_NAME}GitHub刷新失败，继续使用当前数据`, 'warning');
                }
                
            } catch (error) {
                console.error('刷新配置异常:', error);
                showToast(`${PROJECT_NAME}刷新配置失败: ` + error.message, 'error');
            }
        }

        // 根据权限更新UI
        function updateUIForPermissions() {
            if (!currentUser) return;
            
            const canWrite = currentUser.permissions.includes('write');
            const canDelete = currentUser.permissions.includes('delete');
            const canExport = currentUser.permissions.includes('export');
            const canConfig = currentUser.permissions.includes('config');
            
            addBtn.disabled = !canWrite;
            resetBtn.disabled = !canDelete;
            exportBtn.disabled = !canExport;
            syncExcelBtn.disabled = !canExport;
            repairExcelBtn.disabled = !canExport;
            updateHTMLBtn.disabled = !canExport;
            editHeadersBtn.disabled = !canConfig;
            
            const editableHeaders = document.querySelectorAll('.editable-header');
            editableHeaders.forEach(header => {
                if (canConfig) {
                    header.style.cursor = 'pointer';
                } else {
                    header.style.cursor = 'default';
                }
            });
        }

        // 根据权限更新按钮显示状态
        function updateButtonVisibility() {
            const buttons = {
                addBtn: isLoggedIn && currentUser?.permissions?.includes('write'),
                resetBtn: isLoggedIn && currentUser?.permissions?.includes('delete'),
                exportBtn: isLoggedIn && currentUser?.permissions?.includes('export'),
                syncExcelBtn: isLoggedIn && currentUser?.permissions?.includes('export') && gitHubService,
                repairExcelBtn: isLoggedIn && currentUser?.permissions?.includes('export') && gitHubService,
                updateHTMLBtn: isLoggedIn && currentUser?.permissions?.includes('export'),
                editHeadersBtn: isLoggedIn && currentUser?.permissions?.includes('config'),
                downloadExcelBtn: true,
                refreshConfigBtn: true
            };
            
            Object.entries(buttons).forEach(([btnId, shouldShow]) => {
                const btn = document.getElementById(btnId);
                if (btn) {
                    btn.style.display = shouldShow ? 'flex' : 'none';
                    btn.disabled = !shouldShow;
                }
            });
            
            if (sortControls) {
                sortControls.style.display = (isLoggedIn && currentUser?.permissions?.includes('write')) ? 'flex' : 'none';
            }
        }

        // 登录成功
        function loginSuccess(user) {
            isLoggedIn = true;
            currentUser = user;
            
            localStorage.setItem(`${STORAGE_PREFIX}CurrentUser`, JSON.stringify({
                username: user.username,
                name: user.name,
                permissions: user.permissions || ['read']
            }));
            
            // 更新状态显示
            if (gitHubService) {
                updateStatus('success', `您当前是${PROJECT_NAME}管理员模式，GitHub已连接`);
            } else {
                updateStatus('success', `您当前是${PROJECT_NAME}管理员模式`);
            }
            
            // 更新认证面板中的用户信息
            updateAuthUserInfo();
            
            updateUIForPermissions();
            updateButtonVisibility();
            
            const searchTerm = searchInput.value.toLowerCase();
            const activeCategory = document.querySelector('.filter-btn.active')?.dataset.category || 'all';
            filterTable(searchTerm, activeCategory);
            
            setupAutoLogout();
            showToast(`欢迎回来${PROJECT_NAME}，${user.name}！`, 'success');
        }

        // 处理登出
        function handleLogout() {
            isLoggedIn = false;
            currentUser = null;
            
            if (logoutTimer) {
                clearTimeout(logoutTimer);
                logoutTimer = null;
            }
            
            // 更新状态显示
            updateStatus('warning', `您当前是${PROJECT_NAME}访客模式，只能查看数据。请登录管理员账户以进行添加、编辑和删除操作。`);
            
            // 更新认证面板中的用户信息
            updateAuthUserInfo();
            
            updateButtonVisibility();
            
            const searchTerm = searchInput.value.toLowerCase();
            const activeCategory = document.querySelector('.filter-btn.active')?.dataset.category || 'all';
            filterTable(searchTerm, activeCategory);
            
            localStorage.removeItem(`${STORAGE_PREFIX}CurrentUser`);
            showToast(`您已成功退出${PROJECT_NAME}登录`, 'info');
        }

        // 更新分类筛选器 - 使用动态分类
        function updateCategoryFilters() {
            const allButton = filterBox.querySelector('[data-category="all"]');
            
            // 清空除了"全部"按钮之外的其他按钮
            const buttonsToRemove = filterBox.querySelectorAll('.filter-btn:not([data-category="all"])');
            buttonsToRemove.forEach(btn => btn.remove());
            
            // 添加动态分类按钮
            categoryList.forEach(category => {
                const button = document.createElement('button');
                button.className = 'filter-btn';
                button.setAttribute('data-category', category.id);
                button.textContent = category.name;
                filterBox.appendChild(button);
            });
            
            setupFilterEvents();
            
            const activeCategory = document.querySelector('.filter-btn.active')?.dataset.category;
            if (activeCategory) {
                const activeBtn = filterBox.querySelector(`[data-category="${activeCategory}"]`);
                if (activeBtn) {
                    activeBtn.classList.add('active');
                } else {
                    allButton.classList.add('active');
                }
            } else {
                allButton.classList.add('active');
            }
        }

        // 更新分类选择器 - 使用动态分类
        function updateCategorySelect() {
            const categorySelect = document.getElementById('itemCategory');
            const currentValue = categorySelect.value;
            
            console.log('🔄 更新分类选择器...');
            
            categorySelect.innerHTML = `
                <option value="">选择分类</option>
                <option value="__new__">+ 添加新分类</option>
            `;
            
            // 按分类名称排序，以便于查找
            const sortedCategories = [...categoryList].sort((a, b) => 
                a.name.localeCompare(b.name, 'zh-CN')
            );
            
            sortedCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                categorySelect.appendChild(option);
            });
            
            console.log(`选择器选项数量: ${categorySelect.options.length}`);
            
            if (currentValue && categoryList.find(cat => cat.id === currentValue)) {
                categorySelect.value = currentValue;
                console.log(`恢复之前选择的值: ${currentValue}`);
            }
            
            // 添加新分类的逻辑
            categorySelect.addEventListener('change', function() {
                if (this.value === '__new__') {
                    const newCategoryName = prompt('请输入新分类名称:');
                    if (newCategoryName && newCategoryName.trim()) {
                        const newCategoryId = `category${categoryList.length + 1}`;
                        const newCategory = {
                            id: newCategoryId,
                            name: newCategoryName.trim()
                        };
                        
                        categoryList.push(newCategory);
                        categoryMap[newCategoryId] = newCategoryName.trim();
                        
                        updateCategorySelect();
                        updateCategoryFilters();
                        
                        categorySelect.value = newCategoryId;
                        
                        showToast(`新分类 "${newCategoryName}" 已创建！`, 'success');
                    } else {
                        this.value = '';
                    }
                }
            });
        }

        // 更新统计数据
        function updateStats() {
            totalCount.textContent = `总计: ${tableData.length} 个项目`;
            filteredCount.textContent = `显示: ${currentData.length} 个项目`;
        }

        // 显示加载指示器
        function showLoadingIndicator(message) {
            if (loadingIndicator) {
                loadingText.textContent = message;
                loadingIndicator.style.display = 'flex';
            }
        }

        function hideLoadingIndicator() {
            if (loadingIndicator) {
                loadingIndicator.style.display = 'none';
            }
        }

        // 更新配置版本信息函数
        function updateConfigVersionInfo(config) {
            if (!configVersion) return;
            
            const version = config.version || '1.0.0';
            const dataCount = tableData.length;
            const currentTime = new Date().toLocaleString();
            const source = config.source || '未知';
            
            configVersion.textContent = 
                `配置版本: ${version} | 数据量: ${dataCount}条 | 来源: ${source} | 更新时间: ${currentTime}`;
        }

        // 加载保存的 GitHub 令牌
        function loadGitHubToken() {
            const savedToken = localStorage.getItem(`${STORAGE_PREFIX}GithubToken`);
            if (savedToken) {
                gitHubService = new GitHubService(savedToken);
                gitHubService.checkAuth().then(authResult => {
                    if (authResult.authenticated) {
                        console.log('GitHub令牌验证成功:', authResult.username);
                        if (isLoggedIn) {
                            updateStatus('success', `您当前是${PROJECT_NAME}管理员模式，GitHub已连接`);
                        }
                    } else {
                        localStorage.removeItem(`${STORAGE_PREFIX}GithubToken`);
                        gitHubService = null;
                    }
                });
            }
        }

        // ArrayBuffer转Base64函数
        function arrayBufferToBase64(buffer) {
            try {
                const bytes = new Uint8Array(buffer);
                let binary = '';
                for (let i = 0; i < bytes.byteLength; i++) {
                    binary += String.fromCharCode(bytes[i]);
                }
                return btoa(binary);
            } catch (error) {
                console.error('Base64转换失败:', error);
                throw new Error('文件编码转换失败');
            }
        }

        // 修复Excel文件格式功能
        async function repairExcelFormat() {
            if (!isLoggedIn) {
                alert('请先登录管理员账户');
                return;
            }

            if (!gitHubService) {
                alert('请先配置 GitHub 个人访问令牌');
                return;
            }

            try {
                showLoadingIndicator(`正在修复 ${PROJECT_NAME} Excel 文件格式...`);

                const headers = ['序号', '分类', '标题', '地址', '地址类型', '备注'];
                const excelData = [headers];
                
                tableData.forEach(item => {
                    const row = [
                        item.id || '',
                        item.category || '',
                        item.title || '',
                        item.path || '',
                        item.type || 'url',
                        item.note || ''
                    ];
                    excelData.push(row);
                });

                const worksheet = XLSX.utils.aoa_to_sheet(excelData);
                
                const colWidths = [
                    { wch: 8 },   // 序号
                    { wch: 15 },  // 分类
                    { wch: 30 },  // 标题
                    { wch: 50 },  // 地址
                    { wch: 12 },  // 地址类型
                    { wch: 25 }   // 备注
                ];
                worksheet['!cols'] = colWidths;

                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, `${PROJECT_NAME}项目索引表`);
                
                const excelBuffer = XLSX.write(workbook, { 
                    bookType: 'xlsx', 
                    type: 'array',
                    bookSST: false
                });

                const excelBase64 = arrayBufferToBase64(excelBuffer);

                await gitHubService.forceCreateNewFile(
                    'table.xlsx',
                    excelBase64,
                    `修复${PROJECT_NAME}Excel文件格式 - ${new Date().toLocaleString()}`
                );

                hideLoadingIndicator();
                showToast(`✅ ${PROJECT_NAME}Excel文件格式修复完成！SHA冲突已解决。现在可以正常使用同步功能。`, 'success');
                
            } catch (error) {
                console.error('修复Excel格式失败:', error);
                hideLoadingIndicator();
                showToast(`${PROJECT_NAME}修复失败: ${error.message}`, 'error');
            }
        }

        // 修复的下载Excel文件功能
        function downloadExcel() {
            try {
                const headers = ['序号', '分类', '标题', '地址', '地址类型', '备注'];
                const excelData = [headers];
                
                tableData.forEach(item => {
                    const row = [
                        item.id || '',
                        item.category || '',
                        item.title || '',
                        item.path || '',
                        item.type || 'url',
                        item.note || ''
                    ];
                    excelData.push(row);
                });

                const worksheet = XLSX.utils.aoa_to_sheet(excelData);
                const colWidths = [
                    { wch: 8 },   // 序号
                    { wch: 15 },  // 分类
                    { wch: 30 },  // 标题
                    { wch: 50 },  // 地址
                    { wch: 12 },  // 地址类型
                    { wch: 25 }   // 备注
                ];
                worksheet['!cols'] = colWidths;

                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, `${PROJECT_NAME}项目索引表`);
                XLSX.writeFile(workbook, `${PROJECT_NAME}HelpMe索引表.xlsx`);
                
                showToast(`${PROJECT_NAME}Excel文件下载成功！`, 'success');
                
            } catch (error) {
                console.error('下载Excel失败:', error);
                showToast(`${PROJECT_NAME}下载Excel文件失败: ` + error.message, 'error');
            }
        }

        // 生成并下载更新后的HTML文件
        function downloadUpdatedHTML() {
            if (!isLoggedIn) {
                alert('请先登录管理员账户');
                return;
            }
            
            const updatedHTML = generateUpdatedHTML();
            const blob = new Blob([updatedHTML], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${PROJECT_NAME}HelpMe索引表_更新版.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast(`${PROJECT_NAME}更新后的HTML文件已生成并开始下载！`, 'success');
        }

        // 生成包含当前数据的HTML
        function generateUpdatedHTML() {
            const currentHTML = document.documentElement.outerHTML;
            
            // 更新数据定义
            const dataRegex = /let tableData = \[[\s\S]*?\];/;
            const newDataDefinition = `let tableData = ${JSON.stringify(tableData, null, 8)};`;
            let updatedHTML = currentHTML.replace(dataRegex, newDataDefinition);
            
            // 更新表体为空
            const tableBodyRegex = /<tbody id="tableBody">[\s\S]*?<\/tbody>/;
            const emptyTableBody = `<tbody id="tableBody">\n                    <!-- 表格内容将通过JavaScript动态生成 -->\n                </tbody>`;
            updatedHTML = updatedHTML.replace(tableBodyRegex, emptyTableBody);
            
            return updatedHTML;
        }

        // 修复的重置数据功能
        function resetData() {
            if (!isLoggedIn) {
                alert('请先登录管理员账户');
                return;
            }
            
            if (confirm(`确定要重置${PROJECT_NAME}数据吗？这将清除所有本地修改，恢复为GitHub securityconfig的数据。`)) {
                loadConfigFromGitHub(true).then(success => {
                    if (success) {
                        localStorage.removeItem(`${STORAGE_PREFIX}Data`);
                        showToast(`${PROJECT_NAME}数据已重置为GitHub securityconfig的初始状态`, 'success');
                    } else {
                        showToast(`${PROJECT_NAME}GitHub数据加载失败，请检查网络连接`, 'error');
                    }
                });
            }
        }

        // 打开文件夹函数
        function openFolder(path) {
            const decodedPath = path.replace(/\\\\/g, '\\');
            
            if (isLocalEnvironment()) {
                return attemptDirectOpen(decodedPath);
            } else {
                return offerPathCopy(decodedPath, '由于网页安全限制，无法直接打开本地文件夹。');
            }
        }

        // 检测是否为本地环境
        function isLocalEnvironment() {
            const protocol = window.location.protocol;
            const hostname = window.location.hostname;
            
            if (protocol === 'file:') {
                return true;
            }
            
            if (hostname === 'localhost' || hostname === '127.0.0.1' || hostname === '::1') {
                return true;
            }
            
            if (/^(192\.168|10|172\.(1[6-9]|2[0-9]|3[0-1]))\./.test(hostname)) {
                return true;
            }
            
            return false;
        }

        // 尝试直接打开文件夹
        function attemptDirectOpen(decodedPath) {
            const fileUrl = `file:///${decodedPath.replace(/\\/g, '/')}`;
            
            try {
                const newWindow = window.open(fileUrl, '_blank');
                
                if (newWindow === null || newWindow.closed) {
                    throw new Error('窗口打开被阻止');
                }
                
                showToast('正在打开文件夹...', 'info');
                return true;
            } catch (error) {
                console.log('方法1失败:', error.message);
            }
            
            try {
                const link = document.createElement('a');
                link.href = fileUrl;
                link.target = '_blank';
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showToast('正在尝试打开文件夹...', 'info');
                
                setTimeout(() => {
                    offerPathCopy(decodedPath, '如果文件夹没有打开，请使用复制功能：');
                }, 1000);
                
                return true;
            } catch (error) {
                console.log('方法2失败:', error.message);
            }
            
            console.log('所有直接打开方法都失败，使用复制方案');
            offerPathCopy(decodedPath, '直接打开失败，请使用复制功能：');
            return false;
        }

        // 提供路径复制功能
        function offerPathCopy(decodedPath, reason = '') {
            const message = reason + '\n\n是否将以下路径复制到剪贴板？\n\n路径: ' + decodedPath;
            
            if (confirm(message)) {
                copyToClipboard(decodedPath).then(() => {
                    showToast('✅ 路径已复制到剪贴板！', 'success');
                }).catch(err => {
                    fallbackCopy(decodedPath);
                });
            }
            return false;
        }

        // 复制到剪贴板
        async function copyToClipboard(text) {
            if (navigator.clipboard && window.isSecureContext) {
                await navigator.clipboard.writeText(text);
                return true;
            } else {
                return fallbackCopy(text);
            }
        }

        // 备用复制方法
        function fallbackCopy(text) {
            return new Promise((resolve, reject) => {
                try {
                    const textArea = document.createElement('textarea');
                    textArea.value = text;
                    textArea.style.position = 'fixed';
                    textArea.style.opacity = '0';
                    textArea.style.left = '-9999px';
                    document.body.appendChild(textArea);
                    textArea.select();
                    textArea.setSelectionRange(0, 99999);
                    
                    const successful = document.execCommand('copy');
                    document.body.removeChild(textArea);
                    
                    if (successful) {
                        resolve(true);
                    } else {
                        reject(new Error('复制命令失败'));
                    }
                } catch (err) {
                    reject(err);
                }
            });
        }

        // 显示 Toast 消息
        function showToast(message, type = 'info') {
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }
            
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <i class="fas ${getToastIcon(type)}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) toast.remove();
                }, 300);
            }, 3000);
        }

        function getToastIcon(type) {
            const icons = {
                success: 'fa-check-circle',
                error: 'fa-times-circle',
                warning: 'fa-exclamation-triangle',
                info: 'fa-info-circle'
            };
            return icons[type] || 'fa-info-circle';
        }

        // ========== GitHub配置加载函数 ==========
        async function loadConfigFromGitHub(forceRefresh = false) {
            const timestamp = forceRefresh ? `?_=${Date.now()}` : '';
            const configUrl = `${GITHUB_CONFIG_BASE}/config.json${timestamp}`;
            const excelUrl = `${GITHUB_CONFIG_BASE}/table.xlsx${timestamp}`;
            
            console.log('🔄 尝试从GitHub加载配置...');
            
            try {
                showLoadingIndicator('正在从GitHub securityconfig加载配置...');
                
                // 设置超时时间
                const timeoutPromise = new Promise((_, reject) => {
                    setTimeout(() => reject(new Error('GitHub连接超时，请检查网络连接')), 10000);
                });
                
                const configFetch = fetch(configUrl, {
                    cache: forceRefresh ? 'no-cache' : 'default',
                    headers: forceRefresh ? {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache'
                    } : {}
                });
                
                const excelFetch = fetch(excelUrl, {
                    cache: forceRefresh ? 'no-cache' : 'default',
                    headers: forceRefresh ? {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache'
                    } : {}
                });
                
                // 使用Promise.race实现超时控制
                const [configResponse, excelResponse] = await Promise.race([
                    Promise.all([configFetch, excelFetch]),
                    timeoutPromise
                ]);
                
                if (!configResponse.ok) throw new Error(`配置加载失败: HTTP ${configResponse.status}`);
                if (!excelResponse.ok) throw new Error(`Excel加载失败: HTTP ${excelResponse.status}`);
                
                const config = await configResponse.json();
                const arrayBuffer = await excelResponse.arrayBuffer();
                
                await processExcelData(arrayBuffer);
                adminAccounts = config.users || [];
                appConfig = config.settings || {};
                
                // 重新构建分类（从GitHub数据中）
                rebuildCategoriesFromTableData();
                
                updateConfigVersionInfo(config);
                console.log('✅ GitHub securityconfig配置和Excel数据加载成功');
                
                hideLoadingIndicator();
                
                if (isLoggedIn) {
                    updateStatus('success', '已加载GitHub配置，您当前是管理员模式');
                } else {
                    updateStatus('success', '已加载GitHub配置，您当前是访客模式，只能查看数据。请登录管理员账户以进行添加、编辑和删除操作。');
                }
                
                return true;
                
            } catch (error) {
                console.error('❌ GitHub配置加载失败:', error);
                hideLoadingIndicator();
                
                // 不改变当前数据，只是显示错误信息
                if (tableData.length === 0) {
                    updateStatus('error', 'GitHub配置加载失败，请检查网络连接');
                } else {
                    updateStatus('warning', 'GitHub配置加载失败，继续使用当前数据');
                }
                
                return false;
            }
        }

        // 从表格数据重建分类
        function rebuildCategoriesFromTableData() {
            console.log('🔧 从表格数据重建分类系统...');
            
            // 从数据中提取所有唯一的分类
            const categoriesSet = new Set();
            tableData.forEach(item => {
                if (item.category && item.category.trim()) {
                    categoriesSet.add(item.category.trim());
                }
            });
            
            // 将Set转换为数组并排序
            const categoriesArray = Array.from(categoriesSet).sort((a, b) => 
                a.localeCompare(b, 'zh-CN')
            );
            
            console.log('📊 从表格数据中提取的分类:', categoriesArray);
            
            // 构建分类列表和映射
            categoryList = [];
            categoryMap = {};
            
            categoriesArray.forEach((categoryName, index) => {
                const categoryId = `category${index + 1}`;
                categoryList.push({
                    id: categoryId,
                    name: categoryName
                });
                categoryMap[categoryId] = categoryName;
            });
            
            console.log('✅ 重建的分类系统:', {
                categoryList: categoryList,
                categoryMap: categoryMap
            });
            
            // 更新UI
            updateCategoryFilters();
            updateCategorySelect();
        }

        // ========== 处理Excel数据 ==========
        async function processExcelData(arrayBuffer) {
            try {
                const data = new Uint8Array(arrayBuffer);
                const workbook = XLSX.read(data, { 
                    type: 'array',
                    cellText: false,
                    cellDates: true,
                    raw: false
                });
                
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                
                const excelData = XLSX.utils.sheet_to_json(worksheet, { 
                    header: 1,
                    defval: '',
                    blankrows: false
                });
                
                if (excelData.length < 2) {
                    console.warn('Excel文件为空或格式不正确');
                    tableData = [];
                    renderTable(tableData);
                    return;
                }
                
                const headers = excelData[0];
                console.log('Excel表头结构:', headers);
                
                tableData = [];
                
                for (let i = 1; i < excelData.length; i++) {
                    const row = excelData[i];
                    if (row.length === 0 || !row.some(cell => cell !== '' && cell != null)) continue;
                    
                    const item = {
                        id: parseInt(row[0]) || i,
                        category: String(row[1] || '').trim(),
                        title: String(row[2] || '').trim(),
                        path: String(row[3] || '').trim(),
                        type: String(row[4] || 'url').toLowerCase().trim(),
                        note: String(row[5] || '').trim()
                    };
                    
                    if (!item.title && !item.path) continue;
                    
                    tableData.push(item);
                }
                
                console.log('从Excel加载的数据条数:', tableData.length);
                
                // 如果数据为空，显示空表格
                if (tableData.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="5" class="empty-row">GitHub数据为空</td></tr>`;
                } else {
                    renderTable(tableData);
                }
                updateStats();
                
            } catch (error) {
                console.error('Excel数据处理失败:', error);
                throw new Error(`Excel文件处理失败: ${error.message}`);
            }
        }

        // ========== 优化的同步流程 ==========

        // 优化的同步到Excel函数 - 修复重新加载问题
        async function syncDataToExcel() {
            if (!isLoggedIn) {
                alert('请先登录管理员账户');
                return;
            }

            if (!gitHubService) {
                alert('请先配置 GitHub 个人访问令牌');
                showAuthPanel();
                return;
            }

            try {
                showLoadingIndicator(`正在同步数据到 ${PROJECT_NAME} GitHub Excel 文件...`);
                
                // 1. 准备Excel数据
                const headers = ['序号', '分类', '标题', '地址', '地址类型', '备注'];
                const excelData = [headers];
                
                // 确保ID连续
                tableData.forEach((item, index) => {
                    item.id = index + 1; // 重新排序ID
                    const row = [
                        item.id || '',
                        item.category || '',
                        item.title || '',
                        item.path || '',
                        item.type || 'url',
                        item.note || ''
                    ];
                    excelData.push(row);
                });

                // 2. 创建Excel工作表
                const worksheet = XLSX.utils.aoa_to_sheet(excelData);
                
                const colWidths = [
                    { wch: 8 },   // 序号
                    { wch: 15 },  // 分类
                    { wch: 30 },  // 标题
                    { wch: 50 },  // 地址
                    { wch: 12 },  // 地址类型
                    { wch: 25 }   // 备注
                ];
                worksheet['!cols'] = colWidths;

                // 3. 创建Excel工作簿
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, `${PROJECT_NAME}项目索引表`);
                
                // 4. 转换为Base64
                const excelBuffer = XLSX.write(workbook, { 
                    bookType: 'xlsx', 
                    type: 'array',
                    bookSST: false
                });

                const excelBase64 = arrayBufferToBase64(excelBuffer);

                // 5. 上传到GitHub
                await gitHubService.forceCreateFile(
                    'table.xlsx',
                    excelBase64,
                    `${PROJECT_NAME}自动同步表格数据 - ${new Date().toLocaleString()} - 共${tableData.length}条记录`
                );

                // 6. 立即更新本地数据
                saveDataToStorage(); // 保存到本地存储
                
                // 7. 显示成功消息
                hideLoadingIndicator();
                showToast(`✅ ${PROJECT_NAME}数据已成功同步到 GitHub Excel 文件！`, 'success');
                
                // 8. 直接更新UI，不再从GitHub重新加载
                const searchTerm = searchInput.value.toLowerCase();
                const activeCategory = document.querySelector('.filter-btn.active')?.dataset.category || 'all';
                filterTable(searchTerm, activeCategory);
                updateConfigVersionInfo(appConfig);
                
                // 9. 更新状态显示
                updateStatus('success', '数据同步成功！页面已更新为最新数据');
                
            } catch (error) {
                console.error('同步到 Excel 失败:', error);
                hideLoadingIndicator();
                
                if (error.message.includes('文件版本冲突')) {
                    showToast(`${PROJECT_NAME}同步失败: ${error.message}\n\n请先点击"修复Excel格式"按钮，然后重试同步。`, 'error');
                } else {
                    showToast(`${PROJECT_NAME}同步失败: ${error.message}`, 'error');
                }
            }
        }

        // ========== 调试工具函数 ==========

        // 在浏览器控制台可以调用的调试函数
        window.debugCategories = function() {
            console.group('🔍 分类调试信息');
            console.log('当前数据中的分类:', [...new Set(tableData.map(item => item.category).filter(Boolean))]);
            console.log('categoryList:', categoryList);
            console.log('categoryMap:', categoryMap);
            console.log('外部数据文件中的分类:', [...new Set(DEFAULT_TABLE_DATA.map(item => item.category).filter(Boolean))]);
            console.groupEnd();
        };

        // 显示当前项目配置
        window.showProjectConfig = function() {
            console.group('📋 当前项目配置');
            console.log('项目前缀:', PROJECT_PREFIX);
            console.log('项目名称:', PROJECT_NAME);
            console.log('GitHub仓库:', `${GITHUB_OWNER}/${GITHUB_REPO}`);
            console.log('存储前缀:', STORAGE_PREFIX);
            console.log('外部数据条数:', DEFAULT_TABLE_DATA.length);
            console.log('动态分类数量:', categoryList.length);
            console.groupEnd();
            return PROJECT_CONFIG;
        };

        // 页面加载后自动检查
        setTimeout(() => {
            console.log(`🔍 ${PROJECT_NAME}页面加载完成，检查分类系统...`);
            debugCategories();
        }, 2000);
    </script>
</body>
</html>
